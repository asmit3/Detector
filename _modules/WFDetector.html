
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>WFDetector &#8212; Detector-doc 1 documentation</title>
    <link rel="stylesheet" href="../_static/agogo.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head>
  <body>
    <div class="header-wrapper" role="banner">
      <div class="header">
        <div class="headertitle"><a
          href="../index.html">Detector-doc 1 documentation</a></div>
        <div class="rel" role="navigation" aria-label="related navigation">
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a>
        </div>
       </div>
    </div>

    <div class="content-wrapper">
      <div class="content">
        <div class="document">
            
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for WFDetector</h1><div class="highlight"><pre>
<span></span><span class="c1">#--------------------------------------------------------------------------</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Class :py:class:`WFDetector` contains a collection of access methods to waveform detector data</span>
<span class="sd">==============================================================================================</span>

<span class="sd">Usage::</span>

<span class="sd">    # !!! NOTE: None is returned whenever requested information is missing.</span>

<span class="sd">    # import</span>
<span class="sd">    import psana</span>
<span class="sd">    from Detector.WFDetector import WFDetector    </span>

<span class="sd">    # retreive parameters from psana etc.</span>
<span class="sd">    dsname = &#39;exp=sxri0414:run=88&#39;</span>
<span class="sd">    src = &#39;SxrEndstation.0:Acqiris.2&#39; # or its alias &#39;acq02&#39;</span>

<span class="sd">    ds  = psana.DataSource(dsname)</span>
<span class="sd">    env = ds.env()</span>
<span class="sd">    evt = ds.events().next()</span>
<span class="sd">    runnum = evt.run()</span>

<span class="sd">    # parameret par can be either runnum or evt    </span>
<span class="sd">    par = runnum</span>
<span class="sd">    # or</span>
<span class="sd">    par = evt</span>

<span class="sd">    det = WFDetector(src, env, pbits=0, iface=&#39;P&#39;) # iface=&#39;P&#39; or &#39;C&#39; - preferable low level interface (not used in this class)</span>

<span class="sd">    # set parameters, if changed</span>
<span class="sd">    det.set_env(env)</span>
<span class="sd">    det.set_source(source)</span>
<span class="sd">    det.set_print_bits(pbits)</span>
<span class="sd"> </span>
<span class="sd">    # print info</span>
<span class="sd">    det.print_attributes()    </span>
<span class="sd">    det.print_config(evt)</span>

<span class="sd">    instrument = det.instrument()</span>

<span class="sd">    # get array with waveforms</span>
<span class="sd">    wf = det.waveform(evt)</span>

<span class="sd">    # get array with waveform sample times</span>
<span class="sd">    wt = det.wftime(evt)</span>

<span class="sd">    #--------------------------- </span>
<span class="sd">    # Detector-specific methods</span>
<span class="sd">    #---------------------------</span>
<span class="sd">    </span>
<span class="sd">    # access to Acqiris data</span>
<span class="sd">    det.set_correct_acqiris_time(correct_time=True) # (by default)</span>
<span class="sd">    wf, wt = det.raw(evt)</span>
<span class="sd">    # returns two np.array-s with shape = (nbrChannels, nbrSamples) for waveform and associated timestamps or (single) None.</span>
<span class="sd">    </span>
<span class="sd">    # access to Imp data</span>
<span class="sd">    det.set_calib_imp(do_calib_imp=True) # Imp calibration will subtract base level with changing dtype to np.int32</span>
<span class="sd">    wf = det.raw(evt)</span>
<span class="sd">    # returns numpy array with shape=(4, 1023) - samples for 4 channels or None if unavailable.</span>

<span class="sd">See classes</span>
<span class="sd">  - :py:class:`PyDetector` - factory for different detectors</span>
<span class="sd">  - :py:class:`PyDetectorAccess` - Python access interface to data</span>
<span class="sd">  - :py:class:`AreaDetector`  - access to area detector data</span>
<span class="sd">  - :py:class:`PyDetector` - factory for different detectors</span>
<span class="sd">  - :py:class:`WFDetector` - access waveform detector data ACQIRIS and IMP</span>

<span class="sd">This software was developed for the LCLS project.</span>
<span class="sd">If you use all or part of it, please give an appropriate acknowledgment.</span>

<span class="sd">Author Mikhail Dubrovin</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1">#------------------------------</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">_psana</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">PSCalib.GlobalUtils</span> <span class="k">as</span> <span class="nn">gu</span>
<span class="kn">from</span>   <span class="nn">Detector.PyDetectorAccess</span> <span class="k">import</span> <span class="n">PyDetectorAccess</span>

<span class="c1">##-----------------------------</span>

<div class="viewcode-block" id="WFDetector"><a class="viewcode-back" href="../index.html#WFDetector.WFDetector">[docs]</a><span class="k">class</span> <span class="nc">WFDetector</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Python access to wave-form detector data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="c1">##-----------------------------</span>

<div class="viewcode-block" id="WFDetector.__init__"><a class="viewcode-back" href="../index.html#WFDetector.WFDetector.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">pbits</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">iface</span><span class="o">=</span><span class="s1">&#39;P&#39;</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Parameters:</span>
<span class="sd">           src  [str]       - data source, ex: &#39;CxiDs2.0:Cspad.0&#39;</span>
<span class="sd">           env  [psana.Env] - environment, ex: env=ds.env(), where ds=_psana.DataSource(&#39;exp=sxri0414:run=88&#39;)</span>
<span class="sd">           pbits[int]       - print control bit-word</span>
<span class="sd">           iface[char]      - preferable interface: &#39;C&#39; - C++ (everything) or &#39;P&#39; - Python based (not used in this class) </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#print &#39;In c-tor WFDetector&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span>     <span class="o">=</span> <span class="n">env</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pbits</span>   <span class="o">=</span> <span class="n">pbits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iscpp</span>   <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">iface</span><span class="o">==</span><span class="s1">&#39;C&#39;</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ispyt</span>   <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">iface</span><span class="o">==</span><span class="s1">&#39;P&#39;</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_source</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">set_sub</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">=</span> <span class="n">gu</span><span class="o">.</span><span class="n">det_type_from_source</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pyda</span> <span class="o">=</span> <span class="n">PyDetectorAccess</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="n">pbits</span><span class="p">)</span> <span class="c1"># Python data access methods</span>
        <span class="c1">#self.da   = Detector.DetectorAccess(self.source, self.env, pbit) # C++ access methods</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbits</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_members</span><span class="p">()</span></div>

<span class="c1">##-----------------------------</span>

<div class="viewcode-block" id="WFDetector.set_source"><a class="viewcode-back" href="../index.html#WFDetector.WFDetector.set_source">[docs]</a>    <span class="k">def</span> <span class="nf">set_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">srcpar</span><span class="p">,</span> <span class="n">set_sub</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Accepts regular source or alias</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#print &#39;type of srcpar: &#39;, type(srcpar)</span>
        
        <span class="n">src</span> <span class="o">=</span> <span class="n">srcpar</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">srcpar</span><span class="p">,</span> <span class="n">_psana</span><span class="o">.</span><span class="n">Source</span><span class="p">)</span> <span class="k">else</span> <span class="n">_psana</span><span class="o">.</span><span class="n">Source</span><span class="p">(</span><span class="n">srcpar</span><span class="p">)</span>
        <span class="n">str_src</span> <span class="o">=</span> <span class="n">gu</span><span class="o">.</span><span class="n">string_from_source</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>

        <span class="c1"># in case of alias convert it to _psana.Src</span>
        <span class="n">amap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">aliasMap</span><span class="p">()</span>
        <span class="n">psasrc</span> <span class="o">=</span> <span class="n">amap</span><span class="o">.</span><span class="n">src</span><span class="p">(</span><span class="n">str_src</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span>  <span class="o">=</span> <span class="n">src</span> <span class="k">if</span> <span class="n">amap</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">psasrc</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="n">amap</span><span class="o">.</span><span class="n">src</span><span class="p">(</span><span class="n">str_src</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">_psana</span><span class="o">.</span><span class="n">Source</span><span class="p">)</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">_psana</span><span class="o">.</span><span class="n">Source</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbits</span> <span class="o">&amp;</span> <span class="mi">16</span> <span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: input source: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">src</span><span class="p">),</span>\
                  <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  string source: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">str_src</span><span class="p">),</span>\
                  <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  source object: </span><span class="si">%s</span><span class="s1"> of type: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">set_sub</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pyda</span><span class="o">.</span><span class="n">set_source</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span></div>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">print_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> object attributes:&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> \
              <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  source : </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> \
              <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  dettype: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span><span class="p">,</span> \
              <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  detname: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">gu</span><span class="o">.</span><span class="n">dic_det_type_to_name</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dettype</span><span class="p">],</span> \
              <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  pbits  : </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbits</span><span class="p">,</span> \
              <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  iscpp  : </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">iscpp</span><span class="p">,</span> \
              <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  ispyt  : </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ispyt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pyda</span><span class="o">.</span><span class="n">print_attributes</span><span class="p">()</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">set_print_bits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pbits</span><span class="p">)</span> <span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pbits</span> <span class="o">=</span> <span class="n">pbits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pyda</span><span class="o">.</span><span class="n">set_print_bits</span><span class="p">(</span><span class="n">pbits</span><span class="p">)</span>
        <span class="c1">#self.da.set_print_bits(pbits)</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">set_env</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">env</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pyda</span><span class="o">.</span><span class="n">set_env</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
        <span class="c1">#self.da.set_env(env) # is not implemented and is not used this way</span>

<span class="c1">##-----------------------------</span>

<div class="viewcode-block" id="WFDetector.runnum"><a class="viewcode-back" href="../index.html#WFDetector.WFDetector.runnum">[docs]</a>    <span class="k">def</span> <span class="nf">runnum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Returns run number for parameter par which can be evt or runnum(int)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">par</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">par</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">instrument</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pyda</span><span class="o">.</span><span class="n">inst</span><span class="p">()</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">print_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">)</span> <span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pyda</span><span class="o">.</span><span class="n">print_config</span><span class="p">(</span><span class="n">evt</span><span class="p">)</span>

<span class="c1">##-----------------------------</span>

<div class="viewcode-block" id="WFDetector.set_correct_acqiris_time"><a class="viewcode-back" href="../index.html#WFDetector.WFDetector.set_correct_acqiris_time">[docs]</a>    <span class="k">def</span> <span class="nf">set_correct_acqiris_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">correct_time</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;On/off correction of time for acqiris</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pyda</span><span class="o">.</span><span class="n">set_correct_acqiris_time</span><span class="p">(</span><span class="n">correct_time</span><span class="p">)</span></div>

<span class="c1">##-----------------------------</span>

<div class="viewcode-block" id="WFDetector.set_calib_imp"><a class="viewcode-back" href="../index.html#WFDetector.WFDetector.set_calib_imp">[docs]</a>    <span class="k">def</span> <span class="nf">set_calib_imp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">do_calib_imp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;On/off imp calibration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pyda</span><span class="o">.</span><span class="n">set_calib_imp</span><span class="p">(</span><span class="n">do_calib_imp</span><span class="p">)</span></div>

<span class="c1">##-----------------------------</span>

<div class="viewcode-block" id="WFDetector.raw"><a class="viewcode-back" href="../index.html#WFDetector.WFDetector.raw">[docs]</a>    <span class="k">def</span> <span class="nf">raw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns np.array with raw data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pyda</span><span class="o">.</span><span class="n">raw_data</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span></div>

<span class="c1">##-----------------------------</span>

<div class="viewcode-block" id="WFDetector.waveform"><a class="viewcode-back" href="../index.html#WFDetector.WFDetector.waveform">[docs]</a>    <span class="k">def</span> <span class="nf">waveform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns np.array with waveforms</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">evt</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">ACQIRIS</span> <span class="p">:</span>
            <span class="k">if</span> <span class="n">rdata</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
            <span class="n">wf</span><span class="p">,</span> <span class="n">wt</span> <span class="o">=</span> <span class="n">rdata</span>
            <span class="k">return</span> <span class="n">wf</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">IMP</span> <span class="p">:</span>
            <span class="k">return</span> <span class="n">rdata</span> <span class="c1"># returns np.array with shape=(4,1023) or None</span>
        
        <span class="nb">print</span> <span class="s1">&#39;WARNING! </span><span class="si">%s</span><span class="s1">: data for source </span><span class="si">%s</span><span class="s1"> is not found&#39;</span><span class="o">%</span>\
              <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<span class="c1">##-----------------------------</span>

<div class="viewcode-block" id="WFDetector.wftime"><a class="viewcode-back" href="../index.html#WFDetector.WFDetector.wftime">[docs]</a>    <span class="k">def</span> <span class="nf">wftime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns np.array with waveform sample time</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">evt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rdata</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">ACQIRIS</span> <span class="p">:</span>
            <span class="n">wf</span><span class="p">,</span> <span class="n">wt</span> <span class="o">=</span> <span class="n">rdata</span>
            <span class="k">return</span> <span class="n">wt</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">IMP</span> <span class="p">:</span>
            <span class="k">return</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># returns list of integer numbers from 0 to 1022 for wf shape=(4,1023)</span>
        
        <span class="nb">print</span> <span class="s1">&#39;WARNING! </span><span class="si">%s</span><span class="s1">: data for source </span><span class="si">%s</span><span class="s1"> is not found&#39;</span><span class="o">%</span>\
              <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<span class="c1">##-----------------------------</span>

<div class="viewcode-block" id="WFDetector.__call__"><a class="viewcode-back" href="../index.html#WFDetector.WFDetector.__call__">[docs]</a>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Alias for self.raw(evt)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">evt</span><span class="p">)</span></div></div>

<span class="c1">##-----------------------------</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span> <span class="p">:</span>

    <span class="kn">import</span> <span class="nn">psana</span>
    <span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">time</span>
    <span class="kn">from</span> <span class="nn">Detector.GlobalUtils</span> <span class="k">import</span> <span class="n">print_ndarr</span>

    <span class="n">ntest</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="nb">print</span> <span class="s1">&#39;Test # </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ntest</span>

    <span class="n">dsname</span><span class="p">,</span> <span class="n">src</span>                <span class="o">=</span> <span class="s1">&#39;exp=sxri0414:run=88&#39;</span><span class="p">,</span> <span class="n">psana</span><span class="o">.</span><span class="n">Source</span><span class="p">(</span><span class="s1">&#39;DetInfo(acq02)&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ntest</span><span class="o">==</span><span class="mi">2</span>  <span class="p">:</span> <span class="n">dsname</span><span class="p">,</span> <span class="n">src</span> <span class="o">=</span> <span class="s1">&#39;exp=sxri0414:run=88&#39;</span><span class="p">,</span> <span class="n">psana</span><span class="o">.</span><span class="n">Source</span><span class="p">(</span><span class="s1">&#39;DetInfo(SxrEndstation.0:Acqiris.2)&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ntest</span><span class="o">==</span><span class="mi">3</span>  <span class="p">:</span> <span class="n">dsname</span><span class="p">,</span> <span class="n">src</span> <span class="o">=</span> <span class="s1">&#39;exp=cxii0215:run=49&#39;</span><span class="p">,</span> <span class="n">psana</span><span class="o">.</span><span class="n">Source</span><span class="p">(</span><span class="s1">&#39;DetInfo(CxiEndstation.0:Imp.1)&#39;</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s1">&#39;Example for</span><span class="se">\n</span><span class="s1">  dataset: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">  source : </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dsname</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>

    <span class="n">ds</span>  <span class="o">=</span> <span class="n">psana</span><span class="o">.</span><span class="n">DataSource</span><span class="p">(</span><span class="n">dsname</span><span class="p">)</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">env</span><span class="p">()</span>
    <span class="bp">cls</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">calibStore</span><span class="p">()</span>
    <span class="n">eviter</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">events</span><span class="p">()</span>
    <span class="n">evt</span> <span class="o">=</span> <span class="n">eviter</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
    <span class="n">rnum</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">evt</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">:</span> <span class="nb">print</span> <span class="n">key</span>

    <span class="n">det</span> <span class="o">=</span> <span class="n">WFDetector</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">pbits</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">det</span><span class="o">.</span><span class="n">print_attributes</span><span class="p">()</span>    
    <span class="n">det</span><span class="o">.</span><span class="n">print_config</span><span class="p">(</span><span class="n">evt</span><span class="p">)</span>

    <span class="nb">print</span> <span class="s1">&#39;Instrument: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">det</span><span class="o">.</span><span class="n">instrument</span><span class="p">()</span>
    <span class="n">print_ndarr</span><span class="p">(</span><span class="n">det</span><span class="o">.</span><span class="n">waveform</span><span class="p">(</span><span class="n">evt</span><span class="p">),</span> <span class="s1">&#39;test det.waveform(evt)&#39;</span><span class="p">)</span>
    <span class="n">print_ndarr</span><span class="p">(</span><span class="n">det</span><span class="o">.</span><span class="n">wftime</span><span class="p">(</span><span class="n">evt</span><span class="p">),</span> <span class="s1">&#39;test det.wftime(evt)&#39;</span><span class="p">)</span>

    <span class="n">data</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">while</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>
        <span class="n">t0_sec</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">det</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">evt</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Consumed time to get raw data (sec) =&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t0_sec</span>

 
    <span class="kn">import</span> <span class="nn">pyimgalgos.GlobalGraphics</span> <span class="k">as</span> <span class="nn">gg</span>

    <span class="n">wf</span><span class="p">,</span> <span class="n">wt</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">ntest</span><span class="o">&lt;</span><span class="mi">3</span> <span class="p">:</span>
        <span class="n">wf</span><span class="p">,</span> <span class="n">wt</span> <span class="o">=</span> <span class="n">data</span> <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span> 

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">gg</span><span class="o">.</span><span class="n">plotGraph</span><span class="p">(</span><span class="n">wt</span><span class="p">[</span><span class="mi">0</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">wf</span><span class="p">[</span><span class="mi">0</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wt</span><span class="p">[</span><span class="mi">1</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">wf</span><span class="p">[</span><span class="mi">1</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;r-&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wt</span><span class="p">[</span><span class="mi">2</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">wf</span><span class="p">[</span><span class="mi">2</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;g-&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wt</span><span class="p">[</span><span class="mi">3</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">wf</span><span class="p">[</span><span class="mi">3</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;m-&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ntest</span><span class="o">==</span><span class="mi">3</span> <span class="p">:</span> 
        <span class="n">wf</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">wt</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">wf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">gg</span><span class="o">.</span><span class="n">plotGraph</span><span class="p">(</span><span class="n">wt</span><span class="p">,</span> <span class="n">wf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wt</span><span class="p">,</span> <span class="n">wf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;r-&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wt</span><span class="p">,</span> <span class="n">wf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="s1">&#39;g-&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wt</span><span class="p">,</span> <span class="n">wf</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="s1">&#39;m-&#39;</span><span class="p">)</span>

    <span class="n">print_ndarr</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="s1">&#39;wf&#39;</span><span class="p">)</span>
    <span class="n">print_ndarr</span><span class="p">(</span><span class="n">wt</span><span class="p">,</span> <span class="s1">&#39;wt&#39;</span><span class="p">)</span>

    <span class="nb">print</span> <span class="s1">&#39;wf:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">wf</span>

    <span class="n">gg</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span> <span class="p">(</span><span class="s1">&#39;Self test is done&#39;</span><span class="p">)</span>

<span class="c1">##-----------------------------</span>
</pre></div>

          </div>
        </div>
      </div>
        </div>
        <div class="sidebar">
          <h3>Table Of Contents</h3>
          
          <div role="search">
            <h3 style="margin-top: 1.5em;">Search</h3>
            <form class="search" action="../search.html" method="get">
                <input type="text" name="q" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
            </form>
          </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

    <div class="footer-wrapper">
      <div class="footer">
        <div class="left">
          <div role="navigation" aria-label="related navigaton">
            <a href="../py-modindex.html" title="Python Module Index"
              >modules</a> |
            <a href="../genindex.html" title="General Index"
              >index</a>
          </div>
          <div role="note" aria-label="source link">
          </div>
        </div>

        <div class="right">
          
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Mikhail Dubrovin.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.3.
    </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

  </body>
</html>