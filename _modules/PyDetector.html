
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>PyDetector &#8212; Detector-doc 1 documentation</title>
    <link rel="stylesheet" href="../_static/agogo.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head>
  <body>
    <div class="header-wrapper" role="banner">
      <div class="header">
        <div class="headertitle"><a
          href="../index.html">Detector-doc 1 documentation</a></div>
        <div class="rel" role="navigation" aria-label="related navigation">
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a>
        </div>
       </div>
    </div>

    <div class="content-wrapper">
      <div class="content">
        <div class="document">
            
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for PyDetector</h1><div class="highlight"><pre>
<span></span><span class="c1">#------------------------------</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Method :meth:`detector_factory` in :class:`PyDetector` returns instance of the detector data accessor </span>
<span class="sd">=====================================================================================================</span>

<span class="sd">   Method detector_factory(src,env) switches between detector data access objects depending on source parameter.</span>
<span class="sd">   Currently implemented detector data access classes:</span>

<span class="sd">See classes</span>
<span class="sd">  - :class:`AlgoAccess`</span>
<span class="sd">  - :class:`AreaDetector`</span>
<span class="sd">  - :class:`ControlDataDetector`</span>
<span class="sd">  - :class:`DdlDetector`       - access to DDL data</span>
<span class="sd">  - :class:`DetectorTypes`</span>
<span class="sd">  - :class:`EpicsDetector`     - access to EPICS data</span>
<span class="sd">  - :class:`EvrDetector`       - access to EVR data</span>
<span class="sd">  - :class:`Generic1DDetector`</span>
<span class="sd">  - :class:`GenericWFDetector`</span>
<span class="sd">  - :class:`GlobalUtils`</span>
<span class="sd">  - :class:`IpimbDetector`</span>
<span class="sd">  - :class:`OceanDetector`</span>
<span class="sd">  - :class:`PyDataAccess`</span>
<span class="sd">  - :class:`PyDetectorAccess`  - Python access interface to data</span>
<span class="sd">  - :class:`PyDetector`        - factory for different detectors</span>
<span class="sd">  - :class:`TDCDetector`</span>
<span class="sd">  - :class:`UsdUsbDetector`    - UsdUsb Encoder Box</span>
<span class="sd">  - :class:`WFDetector`        - access to waveform detector data</span>

<span class="sd">Usage::</span>

<span class="sd">    # Import</span>
<span class="sd">    import psana</span>

<span class="sd">    # Input parameters</span>
<span class="sd">    # str object for data source can be defined using DAQ detector name</span>
<span class="sd">    src = &#39;XppGon.0:Cspad.0&#39; # or its alias &#39;cspad&#39;</span>
<span class="sd">    # The list of available detector names and alieses for data set can be printed by the command like</span>
<span class="sd">    # detnames exp=xpptut15:run=54</span>

<span class="sd">    # env object can be defined from data set</span>
<span class="sd">    ds = psana.DataSource(&#39;exp=xpptut15:run=54&#39;)</span>
<span class="sd">    env = ds.env()</span>

<span class="sd">    # Create detector object</span>
<span class="sd">    det = psana.Detector(src, env)</span>

<span class="sd">    # in ipython the list of det methods can be seen using &quot;tab completion&quot; operation - type &quot;det.&quot; and hit the Tab key.</span>

<span class="sd">This software was developed for the LCLS project.</span>
<span class="sd">If you use all or part of it, please give an appropriate acknowledgment.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">_psana</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">Detector.DetectorTypes</span> <span class="k">as</span> <span class="nn">dt</span>
<span class="kn">from</span> <span class="nn">Detector.EpicsDetector</span> <span class="k">import</span> <span class="n">EpicsDetector</span>
<span class="kn">from</span> <span class="nn">Detector.ControlDataDetector</span> <span class="k">import</span> <span class="n">ControlDataDetector</span>

<div class="viewcode-block" id="DetInfo"><a class="viewcode-back" href="../index.html#PyDetector.DetInfo">[docs]</a><span class="k">class</span> <span class="nc">DetInfo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class that provides a consistent string repr for all</span>
<span class="sd">    detectors, e.g. BldInfo() types that have only a single</span>
<span class="sd">    name and DetInfo() types that adhere to &quot;.:.&quot; syntax.</span>

<span class="sd">    If that didn&#39;t mean anything to you, then you don&#39;t</span>
<span class="sd">    need this class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="DetInfo.__init__"><a class="viewcode-back" href="../index.html#PyDetector.DetInfo.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">source_string</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Interpret a string like &#39;DetInfo(CxiDs2.0:Cspad.0)&#39; in terms of:</span>
<span class="sd">        </span>
<span class="sd">        detector_type --&gt; &#39;CxiDs2&#39;</span>
<span class="sd">        detector_id   --&gt; 0</span>
<span class="sd">        device_type   --&gt; &#39;Cspad&#39;</span>
<span class="sd">        device_id     --&gt; 0</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;(\w+).(\d)\:(\w+).(\d)&#39;</span><span class="p">,</span> <span class="n">source_string</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">mg</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">det</span> <span class="o">=</span> <span class="n">mg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">detid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">mg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">devid</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mg</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">source_string</span></div>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;det&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dev</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">det</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detid</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;:&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dev</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">devid</span><span class="p">)</span></div>


<span class="c1"># the following function is renamed psana.Detector in the</span>
<span class="c1"># psana __init__.py file</span>
<div class="viewcode-block" id="detector_factory"><a class="viewcode-back" href="../index.html#PyDetector.detector_factory">[docs]</a><span class="k">def</span> <span class="nf">detector_factory</span><span class="p">(</span><span class="n">source_string</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    See psana/src/det_interface.py for documentation</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># &gt; create an instance of the determined detector type &amp; return it</span>
    <span class="n">source_string</span> <span class="o">=</span> <span class="n">map_alias_to_source</span><span class="p">(</span><span class="n">source_string</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">dettype</span><span class="p">(</span><span class="n">source_string</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">det_instance</span> <span class="o">=</span> <span class="n">dt</span><span class="p">(</span><span class="n">source_string</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
    <span class="n">det_instance</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DetInfo</span><span class="p">(</span><span class="n">source_string</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">det_instance</span></div>


<div class="viewcode-block" id="map_alias_to_source"><a class="viewcode-back" href="../index.html#PyDetector.map_alias_to_source">[docs]</a><span class="k">def</span> <span class="nf">map_alias_to_source</span><span class="p">(</span><span class="n">source_string</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check to see if `source_string` is in the `env` alias map, and if so</span>
<span class="sd">    use the alias map to look it up and return the psana Source string</span>
<span class="sd">    corresponding to that alias.</span>

<span class="sd">    Parameters</span>

<span class="sd">    - source_string : str</span>
<span class="sd">        A string identifying a piece of data to access, examples include:</span>

<span class="sd">    - env : psana.Env</span>
<span class="sd">        The psana environment object associated with the psana.DataSource</span>
<span class="sd">        you are interested in (from method DataSource.env()).</span>

<span class="sd">    Returns</span>

<span class="sd">    - source_string : str</span>
<span class="sd">        De-aliased source string -- a unique identifier.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># see if the source_string is an alias</span>
    <span class="n">amap</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">aliasMap</span><span class="p">()</span>
    <span class="n">alias_src</span> <span class="o">=</span> <span class="n">amap</span><span class="o">.</span><span class="n">src</span><span class="p">(</span><span class="n">source_string</span><span class="p">)</span> <span class="c1"># string --&gt; DAQ-style psana.Src</span>

    <span class="c1"># if it is an alias, look up the full name</span>
    <span class="k">if</span> <span class="n">amap</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">alias_src</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>         <span class="c1"># alias found</span>
        <span class="n">source_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">alias_src</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">source_string</span></div>


<span class="c1"># the following function is renamed psana.Detector in the</span>
<span class="c1"># psana __init__.py file</span>
<div class="viewcode-block" id="dettype"><a class="viewcode-back" href="../index.html#PyDetector.dettype">[docs]</a><span class="k">def</span> <span class="nf">dettype</span><span class="p">(</span><span class="n">source_string</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">accept_missing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a python Detector-class &quot;type&quot; from a string identifier.</span>

<span class="sd">    Parameters</span>

<span class="sd">    - source_string : str</span>
<span class="sd">        A string identifying a piece of data to access, examples include:</span>
<span class="sd">          - &#39;cspad&#39;                  # a DAQ detector alias</span>
<span class="sd">          - &#39;XppGon.0:Cspad.0&#39;       # a DAQ detector full-name</span>
<span class="sd">          - &#39;DIAG:FEE1:202:241:Data&#39; # an EPICS variable name (or alias)</span>
<span class="sd">          - &#39;EBeam&#39;                  # a BldInfo identifier\n</span>
<span class="sd">        The idea is that you should be able to pass something that makes</span>
<span class="sd">        sense to you as a human here, and you automatically get the right</span>
<span class="sd">        detector object in return.</span>

<span class="sd">    - env : psana.Env</span>
<span class="sd">        The psana environment object associated with the psana.DataSource</span>
<span class="sd">        you are interested in (from method DataSource.env()).</span>

<span class="sd">    Returns</span>

<span class="sd">    - The type of the appropriate detector class</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">epics</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">epicsStore</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">source_string</span> <span class="ow">in</span> <span class="n">epics</span><span class="o">.</span><span class="n">names</span><span class="p">():</span> <span class="c1"># both names &amp; aliases</span>
        <span class="n">detector_class</span> <span class="o">=</span> <span class="n">EpicsDetector</span>

    <span class="k">elif</span> <span class="n">source_string</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ControlData&#39;</span><span class="p">,</span> <span class="s1">&#39;ScanData&#39;</span><span class="p">]:</span>
        <span class="n">detector_class</span> <span class="o">=</span> <span class="n">ControlDataDetector</span>

    <span class="k">elif</span> <span class="n">source_string</span> <span class="ow">in</span> <span class="n">dt</span><span class="o">.</span><span class="n">bld_info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="c1"># if source is a BldInfo...</span>
        <span class="n">detector_class</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">bld_info</span><span class="p">[</span><span class="n">source_string</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>                                     <span class="c1"># assume source is a DetInfo...</span>
        <span class="n">di</span> <span class="o">=</span> <span class="n">DetInfo</span><span class="p">(</span><span class="n">source_string</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">di</span><span class="o">.</span><span class="n">dev</span> <span class="ow">in</span> <span class="n">dt</span><span class="o">.</span><span class="n">detectors</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">detector_class</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">detectors</span><span class="p">[</span><span class="n">di</span><span class="o">.</span><span class="n">dev</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">accept_missing</span><span class="p">:</span>
                <span class="n">detector_class</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">MissingDet</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Unknown DetInfo device type: </span><span class="si">%s</span><span class="s1"> (source: </span><span class="si">%s</span><span class="s1">)&#39;</span>
                               <span class="s1">&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">di</span><span class="o">.</span><span class="n">dev</span><span class="p">,</span> <span class="n">source_string</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">detector_class</span></div>

<span class="c1">##-----------------------------</span>

<span class="k">def</span> <span class="nf">_test1</span><span class="p">(</span><span class="n">ntest</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test of the detector_factory(src, env) for AreaDetector and WFDetector classes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">time</span>
    <span class="kn">import</span> <span class="nn">psana</span>

    <span class="n">dsname</span><span class="p">,</span> <span class="n">src</span>                  <span class="o">=</span> <span class="s1">&#39;exp=xpptut15:run=54&#39;</span><span class="p">,</span>  <span class="s1">&#39;XppGon.0:Cspad.0&#39;</span>
    <span class="k">if</span>   <span class="n">ntest</span><span class="o">==</span><span class="mi">2</span>  <span class="p">:</span> <span class="n">dsname</span><span class="p">,</span> <span class="n">src</span> <span class="o">=</span> <span class="s1">&#39;exp=meca1113:run=376&#39;</span><span class="p">,</span> <span class="s1">&#39;MecTargetChamber.0:Cspad2x2.1&#39;</span>
    <span class="k">elif</span> <span class="n">ntest</span><span class="o">==</span><span class="mi">3</span>  <span class="p">:</span> <span class="n">dsname</span><span class="p">,</span> <span class="n">src</span> <span class="o">=</span> <span class="s1">&#39;exp=amob5114:run=403&#39;</span><span class="p">,</span> <span class="s1">&#39;Camp.0:pnCCD.0&#39;</span>
    <span class="k">elif</span> <span class="n">ntest</span><span class="o">==</span><span class="mi">4</span>  <span class="p">:</span> <span class="n">dsname</span><span class="p">,</span> <span class="n">src</span> <span class="o">=</span> <span class="s1">&#39;exp=xppi0614:run=74&#39;</span><span class="p">,</span>  <span class="s1">&#39;NoDetector.0:Epix100a.0&#39;</span>
    <span class="k">elif</span> <span class="n">ntest</span><span class="o">==</span><span class="mi">5</span>  <span class="p">:</span> <span class="n">dsname</span><span class="p">,</span> <span class="n">src</span> <span class="o">=</span> <span class="s1">&#39;exp=sxri0414:run=88&#39;</span><span class="p">,</span>  <span class="s1">&#39;SxrEndstation.0:Acqiris.2&#39;</span>
    <span class="k">elif</span> <span class="n">ntest</span><span class="o">==</span><span class="mi">6</span>  <span class="p">:</span> <span class="n">dsname</span><span class="p">,</span> <span class="n">src</span> <span class="o">=</span> <span class="s1">&#39;exp=cxii0215:run=49&#39;</span><span class="p">,</span>  <span class="s1">&#39;CxiEndstation.0:Imp.1&#39;</span>
    <span class="nb">print</span> <span class="s1">&#39;Example for</span><span class="se">\n</span><span class="s1">  dataset: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">  source : </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dsname</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">psana</span><span class="o">.</span><span class="n">DataSource</span><span class="p">(</span><span class="n">dsname</span><span class="p">)</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">env</span><span class="p">()</span>
    <span class="bp">cls</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">calibStore</span><span class="p">()</span>
    <span class="n">eviter</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">events</span><span class="p">()</span>
    <span class="n">evt</span> <span class="o">=</span> <span class="n">eviter</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
    <span class="n">rnum</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">evt</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">:</span> <span class="nb">print</span> <span class="n">key</span>

    <span class="n">det</span> <span class="o">=</span> <span class="n">detector_factory</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>

    <span class="k">try</span> <span class="p">:</span>
        <span class="n">nda</span> <span class="o">=</span> <span class="n">det</span><span class="o">.</span><span class="n">pedestals</span><span class="p">(</span><span class="n">rnum</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">nda:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">nda</span>
        <span class="nb">print</span> <span class="s1">&#39;nda.dtype: </span><span class="si">%s</span><span class="s1"> nda.shape: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nda</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">nda</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;WARNING: det.pedestals(rnum) is not available for dataset: </span><span class="si">%s</span><span class="s1"> and source : </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dsname</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span> 

    <span class="k">try</span> <span class="p">:</span>
        <span class="n">t0_sec</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="n">nda</span> <span class="o">=</span> <span class="n">det</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">evt</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Consumed time to get raw data (sec) =&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t0_sec</span>
        <span class="nb">print</span> <span class="s1">&#39;nda:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">nda</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>
    <span class="k">except</span> <span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;WARNING: det.raw(evt) is not available for dataset: </span><span class="si">%s</span><span class="s1"> and source : </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dsname</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span> 

<span class="c1">##-----------------------------</span>

<span class="k">def</span> <span class="nf">_test2</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Test of the detector_factory(src, env) for EvrDetector, DdlDetectorand and EpicsDetector classes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># test EVR names</span>
    <span class="kn">import</span> <span class="nn">psana</span>

    <span class="c1">#ds = psana.DataSource(&#39;exp=amoj5415:run=43&#39;)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">psana</span><span class="o">.</span><span class="n">DataSource</span><span class="p">(</span><span class="s1">&#39;exp=xpptut15:run=54&#39;</span><span class="p">)</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">env</span><span class="p">()</span>

    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cspad&#39;</span><span class="p">,</span>
             <span class="s1">&#39;XppGon.0:Cspad.0&#39;</span><span class="p">,</span>
             <span class="s1">&#39;evr0&#39;</span><span class="p">,</span>
             <span class="s1">&#39;NoDetector.0:Evr.0&#39;</span><span class="p">,</span>
             <span class="s1">&#39;FEEGasDetEnergy&#39;</span><span class="p">,</span>
             <span class="s1">&#39;EBeam&#39;</span><span class="p">,</span>
             <span class="s1">&#39;dev.0:det.0&#39;</span><span class="p">,</span>
             <span class="s1">&#39;notadet&#39;</span><span class="p">,</span>
             <span class="c1">#&#39;DIAG:FEE1:202:241:Data&#39;,</span>
             <span class="c1">#&#39;XTCAV_yag_status&#39;,</span>
             <span class="c1">#&#39;badname&#39;,</span>
             <span class="p">]</span>

    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="n">det</span> <span class="o">=</span> <span class="n">detector_factory</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
        <span class="nb">print</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;--&gt;&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">det</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">evt</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">events</span><span class="p">():</span>
            <span class="nb">print</span> <span class="n">det</span><span class="p">(</span><span class="n">evt</span><span class="p">)</span>
            <span class="k">break</span>

    <span class="k">return</span> 


<span class="k">def</span> <span class="nf">_test3</span><span class="p">():</span>

    <span class="kn">import</span> <span class="nn">psana</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">psana</span><span class="o">.</span><span class="n">DataSource</span><span class="p">(</span><span class="s1">&#39;exp=xppk3815:run=100:idx&#39;</span><span class="p">)</span>
    <span class="c1">#det = psana.Detector(&#39;ControlData&#39;, ds.env())</span>
    <span class="n">det</span> <span class="o">=</span> <span class="n">psana</span><span class="o">.</span><span class="n">Detector</span><span class="p">(</span><span class="s1">&#39;ControlData&#39;</span><span class="p">)</span>

    <span class="n">run</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">runs</span><span class="p">()</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
    <span class="n">nsteps</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">nsteps</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsteps</span><span class="p">):</span>
        <span class="n">times</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">times</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">times</span><span class="p">[:</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">evt</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="nb">print</span> <span class="n">t</span><span class="p">,</span> <span class="n">det</span><span class="p">()</span><span class="o">.</span><span class="n">pvControls</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
    
    <span class="k">return</span>


<span class="k">def</span> <span class="nf">test4</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">psana</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">psana</span><span class="o">.</span><span class="n">DataSource</span><span class="p">(</span><span class="s1">&#39;exp=xpptut15:run=54&#39;</span><span class="p">)</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">env</span><span class="p">()</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">psana</span><span class="o">.</span><span class="n">Detector</span><span class="p">(</span><span class="s1">&#39;evr0&#39;</span><span class="p">)</span>
    <span class="n">d2</span> <span class="o">=</span> <span class="n">psana</span><span class="o">.</span><span class="n">Detector</span><span class="p">(</span><span class="s1">&#39;yag2&#39;</span><span class="p">)</span>
    <span class="nb">print</span> <span class="n">d</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">d2</span><span class="o">.</span><span class="n">source</span>
    <span class="nb">print</span> <span class="n">d</span><span class="p">(</span> <span class="n">ds</span><span class="o">.</span><span class="n">events</span><span class="p">()</span><span class="o">.</span><span class="n">next</span><span class="p">()</span> <span class="p">)</span>
    <span class="nb">print</span> <span class="n">d2</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span> <span class="n">ds</span><span class="o">.</span><span class="n">events</span><span class="p">()</span><span class="o">.</span><span class="n">next</span><span class="p">()</span> <span class="p">)</span>

<span class="c1">##-----------------------------</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="c1">#for i in range(5): _test1(i)</span>
    <span class="c1">#_test2()</span>
    <span class="n">_test3</span><span class="p">()</span>
    <span class="n">test4</span><span class="p">()</span>

    <span class="kn">import</span> <span class="nn">sys</span><span class="p">;</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

    <span class="k">try</span>    <span class="p">:</span> <span class="n">ntest</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">except</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;First input parameter &quot;</span><span class="si">%s</span><span class="s1">&quot; is expected to be empty or integer test number&#39;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="nb">print</span> <span class="s1">&#39;Test# </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ntest</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">2</span> <span class="p">:</span> <span class="n">_test2</span><span class="p">()</span>
    <span class="k">else</span>               <span class="p">:</span> <span class="n">_test1</span><span class="p">(</span><span class="n">ntest</span><span class="p">)</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span> <span class="p">(</span><span class="s1">&#39;Self test is done&#39;</span><span class="p">)</span>

<span class="c1">##-----------------------------</span>
</pre></div>

          </div>
        </div>
      </div>
        </div>
        <div class="sidebar">
          <h3>Table Of Contents</h3>
          
          <div role="search">
            <h3 style="margin-top: 1.5em;">Search</h3>
            <form class="search" action="../search.html" method="get">
                <input type="text" name="q" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
            </form>
          </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

    <div class="footer-wrapper">
      <div class="footer">
        <div class="left">
          <div role="navigation" aria-label="related navigaton">
            <a href="../py-modindex.html" title="Python Module Index"
              >modules</a> |
            <a href="../genindex.html" title="General Index"
              >index</a>
          </div>
          <div role="note" aria-label="source link">
          </div>
        </div>

        <div class="right">
          
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Mikhail Dubrovin.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.3.
    </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

  </body>
</html>