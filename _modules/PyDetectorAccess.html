
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>PyDetectorAccess &#8212; Detector-doc 1 documentation</title>
    <link rel="stylesheet" href="../_static/agogo.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head>
  <body>
    <div class="header-wrapper" role="banner">
      <div class="header">
        <div class="headertitle"><a
          href="../index.html">Detector-doc 1 documentation</a></div>
        <div class="rel" role="navigation" aria-label="related navigation">
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a>
        </div>
       </div>
    </div>

    <div class="content-wrapper">
      <div class="content">
        <div class="document">
            
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for PyDetectorAccess</h1><div class="highlight"><pre>
<span></span><span class="c1">#--------------------------------------------------------------------------</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Class :py:class:`PyDetectorAccess` contains a collection of python access methods to detector associated information</span>
<span class="sd">====================================================================================================================</span>

<span class="sd">Access method to calibration and geometry parameters, raw data, etc.</span>
<span class="sd">Low level implementation is done on python.</span>

<span class="sd">See classes</span>
<span class="sd">  - :class:`AlgoAccess`</span>
<span class="sd">  - :class:`AreaDetector`</span>
<span class="sd">  - :class:`ControlDataDetector`</span>
<span class="sd">  - :class:`DdlDetector`       - access to DDL data</span>
<span class="sd">  - :class:`DetectorTypes`</span>
<span class="sd">  - :class:`EpicsDetector`     - access to EPICS data</span>
<span class="sd">  - :class:`EvrDetector`       - access to EVR data</span>
<span class="sd">  - :class:`Generic1DDetector`</span>
<span class="sd">  - :class:`GenericWFDetector`</span>
<span class="sd">  - :class:`GlobalUtils`</span>
<span class="sd">  - :class:`IpimbDetector`</span>
<span class="sd">  - :class:`OceanDetector`</span>
<span class="sd">  - :class:`PyDataAccess`</span>
<span class="sd">  - :class:`PyDetectorAccess`  - Python access interface to data</span>
<span class="sd">  - :class:`PyDetector`        - factory for different detectors</span>
<span class="sd">  - :class:`TDCDetector`</span>
<span class="sd">  - :class:`UsdUsbDetector`    - UsdUsb Encoder Box</span>
<span class="sd">  - :class:`WFDetector`        - access to waveform detector dataSee classes</span>

<span class="sd">This software was developed for the LCLS project.</span>
<span class="sd">If you use all or part of it, please give an appropriate acknowledgment.</span>

<span class="sd">Author Mikhail Dubrovin</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1">#------------------------------</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">_psana</span>
<span class="kn">import</span> <span class="nn">Detector.PyDataAccess</span> <span class="k">as</span> <span class="nn">pda</span>

<span class="c1">#import Detector.GlobalUtils as gu</span>
<span class="kn">import</span> <span class="nn">PSCalib.GlobalUtils</span> <span class="k">as</span> <span class="nn">gu</span>

<span class="kn">from</span> <span class="nn">PSCalib.CalibParsStore</span> <span class="k">import</span> <span class="n">cps</span>
<span class="kn">from</span> <span class="nn">PSCalib.CalibFileFinder</span> <span class="k">import</span> <span class="n">CalibFileFinder</span>
<span class="kn">from</span> <span class="nn">PSCalib.GeometryAccess</span> <span class="k">import</span> <span class="n">GeometryAccess</span><span class="p">,</span> <span class="n">img_from_pixel_arrays</span>
<span class="kn">from</span> <span class="nn">PSCalib.NDArrIO</span> <span class="k">import</span> <span class="n">save_txt</span><span class="p">,</span> <span class="n">load_txt</span>
<span class="kn">from</span> <span class="nn">pyimgalgos.cm_epix</span> <span class="k">import</span> <span class="n">cm_epix</span>

<span class="c1">#from pypdsdata.xtc import TypeId  # types from pdsdata/xtc/TypeId.hh, ex: TypeId.Type.Id_CspadElement</span>

<span class="c1">##-----------------------------</span>

<div class="viewcode-block" id="PyDetectorAccess"><a class="viewcode-back" href="../index.html#PyDetectorAccess.PyDetectorAccess">[docs]</a><span class="k">class</span> <span class="nc">PyDetectorAccess</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Class :py:class:`PyDetectorAccess` - python access to detector data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">GEO_NOT_LOADED</span>     <span class="o">=</span> <span class="mi">0</span>
    <span class="n">GEO_LOADED_CALIB</span>   <span class="o">=</span> <span class="mi">1</span>
    <span class="n">GEO_LOADED_DEFAULT</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">GEO_LOADED_DCS</span>     <span class="o">=</span> <span class="mi">3</span>

<span class="c1">##-----------------------------</span>

<div class="viewcode-block" id="PyDetectorAccess.__init__"><a class="viewcode-back" href="../index.html#PyDetectorAccess.PyDetectorAccess.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">pbits</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Class :py:class:`PyDetectorAccess` constructor parameters:</span>

<span class="sd">           - source - data source, ex: _psana.Source(&#39;DetInfo(CxiDs2.0:Cspad.0)&#39;)</span>
<span class="sd">           - env    - environment</span>
<span class="sd">           - pbits  - print control bit-word</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#print &#39;In c-tor DetPyAccess&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">str_src</span><span class="o">=</span> <span class="n">gu</span><span class="o">.</span><span class="n">string_from_source</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span>    <span class="o">=</span> <span class="n">env</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pbits</span>  <span class="o">=</span> <span class="n">pbits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">=</span> <span class="n">gu</span><span class="o">.</span><span class="n">det_type_from_source</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">str_src</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_offset</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># works for camera</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">correct_time</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># works for acqiris</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_calib_imp</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># works for imp </span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbits</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_attributes</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cpst</span> <span class="o">=</span> <span class="kc">None</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">runnum_cps</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">geo</span> <span class="o">=</span> <span class="kc">None</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">runnum_geo</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mbits</span>      <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cfg_gain_mask_is_loaded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runnum_cfg</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gain_mask</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">counter_cspad2x2_msg</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reshape_to_3d</span> <span class="o">=</span> <span class="kc">False</span></div>

<span class="c1">##-----------------------------</span>

<div class="viewcode-block" id="PyDetectorAccess.runnum"><a class="viewcode-back" href="../index.html#PyDetectorAccess.PyDetectorAccess.runnum">[docs]</a>    <span class="k">def</span> <span class="nf">runnum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns integer run number from different options of input parameter.</span>
<span class="sd">        </span>
<span class="sd">           Parameter</span>

<span class="sd">           - par : int or psana.Event() - integer run number or psana event object.</span>

<span class="sd">           Returns</span>

<span class="sd">           - int - run number or 0 if can&#39;t be defined.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">par</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">par</span><span class="o">.</span><span class="n">run</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">_psana</span><span class="o">.</span><span class="n">Event</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span> </div>

<span class="c1">##-----------------------------</span>

<div class="viewcode-block" id="PyDetectorAccess.time_par"><a class="viewcode-back" href="../index.html#PyDetectorAccess.PyDetectorAccess.time_par">[docs]</a>    <span class="k">def</span> <span class="nf">time_par</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns parameter which can be used to define dataset time, _psana.Event or _psana.Env.object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">par</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">par</span><span class="p">,</span><span class="n">_psana</span><span class="o">.</span><span class="n">Event</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span></div>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">cpstore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="p">:</span> <span class="c1"># par = evt or runnum</span>

        <span class="n">runnum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runnum</span><span class="p">(</span><span class="n">par</span><span class="p">)</span>
        <span class="c1">#print 80*&#39;_&#39;</span>
        <span class="c1">#print &#39;cpstore XXX runnum = %d&#39; % runnum</span>
        <span class="c1">#print &#39;cpstore XXX par&#39;, par,</span>
        <span class="c1">#print &#39;XXX  isinstance(par, psana.Event)&#39;, isinstance(par, _psana.Event)</span>

        <span class="c1"># for 1st entry and when runnum is changing:</span>
        <span class="k">if</span> <span class="n">runnum</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runnum_cps</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpst</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runnum_cps</span> <span class="o">=</span> <span class="n">runnum</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">gu</span><span class="o">.</span><span class="n">dic_det_type_to_calib_group</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dettype</span><span class="p">]</span>
            <span class="c1">#self.cpst = cps.Create(self.env.calibDir(), group, self.str_src, runnum, self.pbits)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cpst</span> <span class="o">=</span> <span class="n">cps</span><span class="o">.</span><span class="n">CreateForEvtEnv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">calibDir</span><span class="p">(),</span> <span class="n">group</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">str_src</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbits</span> <span class="o">&amp;</span> <span class="mi">0377</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbits</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="p">:</span> <span class="nb">print</span> <span class="s1">&#39;PSCalib.CalibParsStore object is created for run </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">runnum</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpst</span>

<span class="c1">##-----------------------------</span>

<div class="viewcode-block" id="PyDetectorAccess.default_geometry"><a class="viewcode-back" href="../index.html#PyDetectorAccess.PyDetectorAccess.default_geometry">[docs]</a>    <span class="k">def</span> <span class="nf">default_geometry</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns default geometry object for some of detectors&quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">CalibManager.AppDataPath</span> <span class="k">as</span> <span class="nn">apputils</span>

        <span class="n">defname</span> <span class="o">=</span> <span class="s1">&#39;Detector/geometry-def-epix100a.data&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">EPIX100A</span>\
             <span class="k">else</span> <span class="s1">&#39;Detector/geometry-def-pnccd.data&#39;</span>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">PNCCD</span>\
             <span class="k">else</span> <span class="s1">&#39;Detector/geometry-def-cspad.data&#39;</span>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">CSPAD</span>\
             <span class="k">else</span> <span class="s1">&#39;Detector/geometry-def-cspad2x2.data&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">CSPAD2X2</span>\
             <span class="k">else</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">defname</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geo</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span>

        <span class="n">fname</span> <span class="o">=</span> <span class="n">apputils</span><span class="o">.</span><span class="n">AppDataPath</span><span class="p">(</span><span class="n">defname</span><span class="p">)</span><span class="o">.</span><span class="n">path</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbits</span> <span class="p">:</span> <span class="nb">print</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: Load default geometry from file </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
         
        <span class="bp">self</span><span class="o">.</span><span class="n">geo</span> <span class="o">=</span> <span class="n">GeometryAccess</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="mi">0377</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbits</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo_load_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GEO_LOADED_DEFAULT</span>    </div>
        <span class="c1">#return GeometryAccess(fname, 0377 if self.pbits else 0)</span>

<span class="c1">##-----------------------------</span>

<div class="viewcode-block" id="PyDetectorAccess.geoaccess_dcs"><a class="viewcode-back" href="../index.html#PyDetectorAccess.PyDetectorAccess.geoaccess_dcs">[docs]</a>    <span class="k">def</span> <span class="nf">geoaccess_dcs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tpar</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns geometry object.</span>

<span class="sd">        Parameter</span>

<span class="sd">        - tpar : _psana.Event | _psana.Env | float time</span>

<span class="sd">        Returns</span>

<span class="sd">        - GeometryAccess - geometry object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">PSCalib.DCMethods</span> <span class="k">as</span> <span class="nn">dcm</span>

        <span class="n">cdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">calibDir</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">dcm</span><span class="o">.</span><span class="n">get_constants</span><span class="p">(</span><span class="n">tpar</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">str_src</span><span class="p">,</span> <span class="n">ctype</span><span class="o">=</span><span class="n">gu</span><span class="o">.</span><span class="n">GEOMETRY</span><span class="p">,</span> <span class="n">calibdir</span><span class="o">=</span><span class="n">cdir</span><span class="p">,</span> <span class="n">vers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pbits</span> <span class="o">&amp;</span> <span class="mi">16</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span>

        <span class="c1">#for s in data : print &#39;XXX: %s&#39; % s</span>
        <span class="c1">#import tempfile</span>
        <span class="c1">#fntmp = tempfile.NamedTemporaryFile(mode=&#39;r+b&#39;,suffix=&#39;.data&#39;)</span>
        <span class="c1">#print &#39;XXX Save constants in tmp file: %s&#39; % fntmp.name</span>
        <span class="c1">#save_txt(fntmp.name, data, cmts=&#39;&#39;, fmt=&#39;%.1f&#39;)</span>
        <span class="c1">#self.geo = GeometryAccess(fntmp.name, 0377 if self.pbits else 0)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">geo</span> <span class="o">=</span> <span class="n">GeometryAccess</span><span class="p">(</span><span class="n">pbits</span><span class="o">=</span><span class="mi">0377</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbits</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">load_pars_from_str</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="c1">#self.geo.print_list_of_geos()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geo_load_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GEO_LOADED_DCS</span></div>

<span class="c1">##-----------------------------</span>

<div class="viewcode-block" id="PyDetectorAccess.geoaccess_calib"><a class="viewcode-back" href="../index.html#PyDetectorAccess.PyDetectorAccess.geoaccess_calib">[docs]</a>    <span class="k">def</span> <span class="nf">geoaccess_calib</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runnum</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns geometry object from calib store or None if can&#39;t load geometry.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">gu</span><span class="o">.</span><span class="n">dic_det_type_to_calib_group</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dettype</span><span class="p">]</span>
        <span class="n">cff</span> <span class="o">=</span> <span class="n">CalibFileFinder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">calibDir</span><span class="p">(),</span> <span class="n">group</span><span class="p">,</span> <span class="mi">0377</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbits</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">cff</span><span class="o">.</span><span class="n">findCalibFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">str_src</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="n">runnum</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fname</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geo</span> <span class="o">=</span> <span class="n">GeometryAccess</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="mi">0377</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbits</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbits</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="p">:</span> <span class="nb">print</span> <span class="s1">&#39;PSCalib.GeometryAccess object is created for run </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">runnum</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">valid</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo_load_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GEO_LOADED_CALIB</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geo</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbits</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="p">:</span> <span class="nb">print</span> <span class="s1">&#39;WARNING: PSCalib.GeometryAccess object is NOT created for run </span><span class="si">%d</span><span class="s1"> - geometry file is missing.&#39;</span> <span class="o">%</span> <span class="n">runnum</span></div>

<span class="c1">##-----------------------------</span>

<div class="viewcode-block" id="PyDetectorAccess.geoaccess"><a class="viewcode-back" href="../index.html#PyDetectorAccess.PyDetectorAccess.geoaccess">[docs]</a>    <span class="k">def</span> <span class="nf">geoaccess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="p">:</span> <span class="c1"># par = _psana.Event | int runnum</span>
        <span class="sd">&quot;&quot;&quot;Returns geometry or None if can&#39;t load.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">runnum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runnum</span><span class="p">(</span><span class="n">par</span><span class="p">)</span>

        <span class="k">if</span>  <span class="n">runnum</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runnum_geo</span> <span class="p">:</span>
            <span class="c1"># for 1st entry and when run is changing:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runnum_geo</span> <span class="o">=</span> <span class="n">runnum</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geo_load_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GEO_NOT_LOADED</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geo</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># 1) load geometry object from calib store</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geoaccess_calib</span><span class="p">(</span><span class="n">runnum</span><span class="p">)</span>

            <span class="c1"># 2) fallback load file from DCS</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">geoaccess_dcs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_par</span><span class="p">(</span><span class="n">par</span><span class="p">))</span>

            <span class="c1"># 3) load default geometry if it is still unavailable. Implemented for a few detectors.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">default_geometry</span><span class="p">()</span>

            <span class="c1"># arrays for caching</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iX</span>             <span class="o">=</span> <span class="kc">None</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">iY</span>             <span class="o">=</span> <span class="kc">None</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">coords_x_arr</span>   <span class="o">=</span> <span class="kc">None</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">coords_y_arr</span>   <span class="o">=</span> <span class="kc">None</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">coords_z_arr</span>   <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">areas_arr</span>      <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask_geo_arr</span>   <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mbits</span>          <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pixel_size_val</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span></div>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">print_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;PyDetectorAccess attributes:</span><span class="se">\n</span><span class="s1">  source: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">  dtype : </span><span class="si">%d</span><span class="se">\n</span><span class="s1">  pbits : </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> \
              <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbits</span><span class="p">),</span> \
              <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  do_offset (Camera): </span><span class="si">%s</span><span class="se">\n</span><span class="s1">  correct_time (Acqiris): </span><span class="si">%s</span><span class="se">\n</span><span class="s1">  do_calib_imp (Imp): </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
              <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">do_offset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">correct_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_calib_imp</span><span class="p">)</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">set_env</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">env</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">set_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span> <span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">str_src</span> <span class="o">=</span> <span class="n">gu</span><span class="o">.</span><span class="n">string_from_source</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">pedestals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="p">:</span> <span class="c1"># par: evt or runnum(int)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpstore</span><span class="p">(</span><span class="n">par</span><span class="p">)</span><span class="o">.</span><span class="n">pedestals</span><span class="p">()</span>
    
<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">pixel_rms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpstore</span><span class="p">(</span><span class="n">par</span><span class="p">)</span><span class="o">.</span><span class="n">pixel_rms</span><span class="p">()</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">pixel_gain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpstore</span><span class="p">(</span><span class="n">par</span><span class="p">)</span><span class="o">.</span><span class="n">pixel_gain</span><span class="p">()</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">pixel_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpstore</span><span class="p">(</span><span class="n">par</span><span class="p">)</span><span class="o">.</span><span class="n">pixel_offset</span><span class="p">()</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">pixel_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpstore</span><span class="p">(</span><span class="n">par</span><span class="p">)</span><span class="o">.</span><span class="n">pixel_mask</span><span class="p">()</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">pixel_bkgd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpstore</span><span class="p">(</span><span class="n">par</span><span class="p">)</span><span class="o">.</span><span class="n">pixel_bkgd</span><span class="p">()</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">pixel_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpstore</span><span class="p">(</span><span class="n">par</span><span class="p">)</span><span class="o">.</span><span class="n">pixel_status</span><span class="p">()</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">pixel_datast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpstore</span><span class="p">(</span><span class="n">par</span><span class="p">)</span><span class="o">.</span><span class="n">pixel_datast</span><span class="p">()</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">common_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpstore</span><span class="p">(</span><span class="n">par</span><span class="p">)</span><span class="o">.</span><span class="n">common_mode</span><span class="p">()</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">common_mode_apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alg_num</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">nda</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">alg_num</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">cm_epix</span><span class="p">(</span><span class="n">img</span><span class="o">=</span><span class="n">nda</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;alg_num does not exist&#39;</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">ndim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ctype</span><span class="o">=</span><span class="n">gu</span><span class="o">.</span><span class="n">PEDESTALS</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">sh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">sh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="n">sh</span><span class="o">.</span><span class="n">size</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpstore</span><span class="p">(</span><span class="n">par</span><span class="p">)</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">ctype</span><span class="p">)</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ctype</span><span class="o">=</span><span class="n">gu</span><span class="o">.</span><span class="n">PEDESTALS</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">sh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">sh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="n">sh</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpstore</span><span class="p">(</span><span class="n">par</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ctype</span><span class="p">)</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">shape_calib</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">ctype</span><span class="o">=</span><span class="n">gu</span><span class="o">.</span><span class="n">PEDESTALS</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpstore</span><span class="p">(</span><span class="n">par</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">ctype</span><span class="p">)</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">ctype</span><span class="o">=</span><span class="n">gu</span><span class="o">.</span><span class="n">PEDESTALS</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpstore</span><span class="p">(</span><span class="n">par</span><span class="p">)</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="n">ctype</span><span class="p">)</span>

<span class="c1">##-----------------------------</span>
<span class="c1">##-----------------------------</span>
<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">_shaped_geo_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">if</span> <span class="n">arr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">EPIX100A</span> <span class="p">:</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">704</span><span class="p">,</span> <span class="mi">768</span><span class="p">)</span>
        <span class="c1">#if self.dettype == gu.CSPAD    : arr.shape = (32, 185, 388)</span>
        <span class="k">return</span> <span class="n">arr</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">_update_coord_arrays</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">do_update</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Returns True if pixel index arrays are available, othervise False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoaccess</span><span class="p">(</span><span class="n">par</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="k">if</span>  <span class="bp">self</span><span class="o">.</span><span class="n">coords_x_arr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">do_update</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coords_x_arr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords_y_arr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords_z_arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">get_pixel_coords</span><span class="p">()</span>
            <span class="k">if</span>  <span class="bp">self</span><span class="o">.</span><span class="n">coords_x_arr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">coords_x</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_coord_arrays</span><span class="p">(</span><span class="n">par</span><span class="p">)</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shaped_geo_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords_x_arr</span><span class="p">)</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">coords_y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_coord_arrays</span><span class="p">(</span><span class="n">par</span><span class="p">)</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shaped_geo_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords_y_arr</span><span class="p">)</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">coords_z</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_coord_arrays</span><span class="p">(</span><span class="n">par</span><span class="p">)</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shaped_geo_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords_z_arr</span><span class="p">)</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">coords_xy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_coord_arrays</span><span class="p">(</span><span class="n">par</span><span class="p">)</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shaped_geo_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords_x_arr</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shaped_geo_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords_y_arr</span><span class="p">)</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">coords_xyz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_coord_arrays</span><span class="p">(</span><span class="n">par</span><span class="p">)</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shaped_geo_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords_x_arr</span><span class="p">),</span>\
               <span class="bp">self</span><span class="o">.</span><span class="n">_shaped_geo_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords_y_arr</span><span class="p">),</span>\
               <span class="bp">self</span><span class="o">.</span><span class="n">_shaped_geo_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords_z_arr</span><span class="p">)</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">areas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoaccess</span><span class="p">(</span><span class="n">par</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="k">if</span>  <span class="bp">self</span><span class="o">.</span><span class="n">areas_arr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">areas_arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">get_pixel_areas</span><span class="p">()</span>
        <span class="k">return</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_shaped_geo_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">areas_arr</span><span class="p">)</span>

<span class="c1">##-----------------------------</span>

    <span class="c1"># mbits = +1-edges; +2-wide central cols; +4-non-bond; +8/+16-four/eight non-bond neighbors</span>
    <span class="k">def</span> <span class="nf">mask_geo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">mbits</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="p">:</span>

        <span class="k">if</span> <span class="n">mbits</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mbits</span> <span class="p">:</span> <span class="c1"># check if update is required</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mbits</span> <span class="o">=</span> <span class="n">mbits</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask_geo_arr</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoaccess</span><span class="p">(</span><span class="n">par</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="k">if</span>  <span class="bp">self</span><span class="o">.</span><span class="n">mask_geo_arr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">mask_geo_arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">get_pixel_mask</span><span class="p">(</span><span class="n">mbits</span><span class="o">=</span><span class="n">mbits</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_shaped_geo_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_geo_arr</span><span class="p">)</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">_update_index_arrays</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">pix_scale_size_um</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xy0_off_pix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">do_update</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Returns True if pixel index arrays are available, othervise False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoaccess</span><span class="p">(</span><span class="n">par</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="k">if</span>  <span class="bp">self</span><span class="o">.</span><span class="n">iX</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">do_update</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">iX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">iY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">get_pixel_coord_indexes</span><span class="p">(</span><span class="n">oname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">oindex</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>\
                                                       <span class="n">pix_scale_size_um</span><span class="o">=</span><span class="n">pix_scale_size_um</span><span class="p">,</span>\
                                                       <span class="n">xy0_off_pix</span><span class="o">=</span><span class="n">xy0_off_pix</span><span class="p">,</span> <span class="n">do_tilt</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span>  <span class="bp">self</span><span class="o">.</span><span class="n">iX</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

<span class="c1">##-----------------------------</span>

<div class="viewcode-block" id="PyDetectorAccess.indexes_x"><a class="viewcode-back" href="../index.html#PyDetectorAccess.PyDetectorAccess.indexes_x">[docs]</a>    <span class="k">def</span> <span class="nf">indexes_x</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">pix_scale_size_um</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xy0_off_pix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">do_update</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns pixel index array iX.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_index_arrays</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">pix_scale_size_um</span><span class="p">,</span> <span class="n">xy0_off_pix</span><span class="p">,</span> <span class="n">do_update</span><span class="p">)</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shaped_geo_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iX</span><span class="p">)</span></div>

<span class="c1">##-----------------------------</span>

<div class="viewcode-block" id="PyDetectorAccess.indexes_y"><a class="viewcode-back" href="../index.html#PyDetectorAccess.PyDetectorAccess.indexes_y">[docs]</a>    <span class="k">def</span> <span class="nf">indexes_y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">pix_scale_size_um</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xy0_off_pix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">do_update</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns pixel index array iY.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_index_arrays</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">pix_scale_size_um</span><span class="p">,</span> <span class="n">xy0_off_pix</span><span class="p">,</span> <span class="n">do_update</span><span class="p">)</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shaped_geo_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iY</span><span class="p">)</span></div>

<span class="c1">##-----------------------------</span>

<div class="viewcode-block" id="PyDetectorAccess.indexes_xy"><a class="viewcode-back" href="../index.html#PyDetectorAccess.PyDetectorAccess.indexes_xy">[docs]</a>    <span class="k">def</span> <span class="nf">indexes_xy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">pix_scale_size_um</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xy0_off_pix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">do_update</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns two pixel index arrays iX and iY.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_index_arrays</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">pix_scale_size_um</span><span class="p">,</span> <span class="n">xy0_off_pix</span><span class="p">,</span> <span class="n">do_update</span><span class="p">)</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">iX</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span> <span class="c1"># single None is not the same as (None, None) !</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shaped_geo_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iX</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shaped_geo_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iY</span><span class="p">)</span></div>

<span class="c1">##-----------------------------</span>

<div class="viewcode-block" id="PyDetectorAccess.point_indexes"><a class="viewcode-back" href="../index.html#PyDetectorAccess.PyDetectorAccess.point_indexes">[docs]</a>    <span class="k">def</span> <span class="nf">point_indexes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">pxy_um</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">pix_scale_size_um</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xy0_off_pix</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns ix, iy indexes of the point p_um x,y coordinates in [um]&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoaccess</span><span class="p">(</span><span class="n">par</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">ix</span><span class="p">,</span> <span class="n">iy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">point_coord_indexes</span><span class="p">(</span><span class="n">p_um</span><span class="o">=</span><span class="n">pxy_um</span><span class="p">,</span> <span class="n">oname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">oindex</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>\
                                              <span class="n">pix_scale_size_um</span><span class="o">=</span><span class="n">pix_scale_size_um</span><span class="p">,</span>\
                                              <span class="n">xy0_off_pix</span><span class="o">=</span><span class="n">xy0_off_pix</span><span class="p">,</span> <span class="n">do_tilt</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ix</span><span class="p">,</span> <span class="n">iy</span></div>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">pixel_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoaccess</span><span class="p">(</span><span class="n">par</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="k">if</span>  <span class="bp">self</span><span class="o">.</span><span class="n">pixel_size_val</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">pixel_size_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">get_pixel_scale_size</span><span class="p">()</span>
        <span class="k">return</span>  <span class="bp">self</span><span class="o">.</span><span class="n">pixel_size_val</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">move_geo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoaccess</span><span class="p">(</span><span class="n">par</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">pass</span>
        <span class="k">else</span> <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">move_geo</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">)</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">tilt_geo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">dtx</span><span class="p">,</span> <span class="n">dty</span><span class="p">,</span> <span class="n">dtz</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoaccess</span><span class="p">(</span><span class="n">par</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">pass</span>
        <span class="k">else</span> <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">tilt_geo</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dtx</span><span class="p">,</span> <span class="n">dty</span><span class="p">,</span> <span class="n">dtz</span><span class="p">)</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">image_xaxis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">pix_scale_size_um</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">x0_off_pix</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">pix_size</span> <span class="o">=</span> <span class="n">pix_scale_size_um</span> <span class="k">if</span> <span class="n">pix_scale_size_um</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel_size</span><span class="p">(</span><span class="n">par</span><span class="p">)</span>
        <span class="n">carr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords_x</span><span class="p">(</span><span class="n">par</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">carr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="n">cmin</span><span class="p">,</span> <span class="n">cmax</span> <span class="o">=</span> <span class="n">carr</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">carr</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">pix_size</span>
        <span class="k">if</span> <span class="n">x0_off_pix</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">cmin</span><span class="p">,</span> <span class="n">cmax</span><span class="p">,</span> <span class="n">pix_size</span><span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">cmin</span><span class="o">-</span><span class="n">pix_size</span><span class="o">*</span><span class="n">x0_off_pix</span><span class="p">,</span> <span class="n">cmax</span><span class="p">,</span> <span class="n">pix_size</span><span class="p">)</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">image_yaxis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">pix_scale_size_um</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y0_off_pix</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">pix_size</span> <span class="o">=</span> <span class="n">pix_scale_size_um</span> <span class="k">if</span> <span class="n">pix_scale_size_um</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel_size</span><span class="p">(</span><span class="n">par</span><span class="p">)</span>
        <span class="n">carr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords_y</span><span class="p">(</span><span class="n">par</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">carr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="n">cmin</span><span class="p">,</span> <span class="n">cmax</span> <span class="o">=</span> <span class="n">carr</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">carr</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">pix_size</span>
        <span class="k">if</span> <span class="n">y0_off_pix</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">cmin</span><span class="p">,</span> <span class="n">cmax</span><span class="p">,</span> <span class="n">pix_size</span><span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">cmin</span><span class="o">-</span><span class="n">pix_size</span><span class="o">*</span><span class="n">y0_off_pix</span><span class="p">,</span> <span class="n">cmax</span><span class="p">,</span> <span class="n">pix_size</span><span class="p">)</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">img_nda</span><span class="p">,</span> <span class="n">pix_scale_size_um</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xy0_off_pix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">do_update</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_index_arrays</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">pix_scale_size_um</span><span class="p">,</span> <span class="n">xy0_off_pix</span><span class="p">,</span> <span class="n">do_update</span><span class="p">)</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">img_from_pixel_arrays</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">iY</span><span class="p">,</span> <span class="n">img_nda</span><span class="p">)</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">do_reshape_2d_to_3d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reshape_to_3d</span> <span class="o">=</span> <span class="n">flag</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">ndarray_from_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">pix_scale_size_um</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xy0_off_pix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">do_update</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="p">:</span>

        <span class="k">if</span> <span class="n">image</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># 2016-06-05 return image if reshaping to 3d is requested and geometry is missing</span>
        <span class="c1"># !!! there is no check that original array is 2d or specific detector type. </span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reshape_to_3d</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoaccess</span><span class="p">(</span><span class="n">par</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> 
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_index_arrays</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">pix_scale_size_um</span><span class="p">,</span> <span class="n">xy0_off_pix</span><span class="p">,</span> <span class="n">do_update</span><span class="p">)</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shaped_geo_array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">image</span><span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">iY</span><span class="p">)]))</span>

<span class="c1">##-----------------------------</span>
<span class="c1">##-----------------------------</span>
<span class="c1">##-----------------------------</span>
<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">inst</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">instrument</span><span class="p">()</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">print_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">)</span> <span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:print_config(evt) - is not implemented in pythonic version&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">set_print_bits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pbits</span><span class="p">)</span> <span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pbits</span>  <span class="o">=</span> <span class="n">pbits</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpst</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpst</span><span class="o">.</span><span class="n">set_print_bits</span><span class="p">(</span><span class="mi">0177777</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span>  <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">set_print_bits</span><span class="p">(</span><span class="mi">0377</span> <span class="k">if</span> <span class="n">pbits</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1">##-----------------------------</span>

<div class="viewcode-block" id="PyDetectorAccess.set_do_offset"><a class="viewcode-back" href="../index.html#PyDetectorAccess.PyDetectorAccess.set_do_offset">[docs]</a>    <span class="k">def</span> <span class="nf">set_do_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">do_offset</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;On/off application of offset in raw_data_camera(...)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_offset</span> <span class="o">=</span> <span class="n">do_offset</span></div>

<span class="c1">##-----------------------------</span>

<div class="viewcode-block" id="PyDetectorAccess.set_correct_acqiris_time"><a class="viewcode-back" href="../index.html#PyDetectorAccess.PyDetectorAccess.set_correct_acqiris_time">[docs]</a>    <span class="k">def</span> <span class="nf">set_correct_acqiris_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">correct_time</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;On/off correction of time for acqiris</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">correct_time</span> <span class="o">=</span> <span class="n">correct_time</span></div>

<span class="c1">##-----------------------------</span>

<div class="viewcode-block" id="PyDetectorAccess.set_calib_imp"><a class="viewcode-back" href="../index.html#PyDetectorAccess.PyDetectorAccess.set_calib_imp">[docs]</a>    <span class="k">def</span> <span class="nf">set_calib_imp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">do_calib_imp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;On/off imp calibration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_calib_imp</span> <span class="o">=</span> <span class="n">do_calib_imp</span></div>

<span class="c1">##-----------------------------</span>

<div class="viewcode-block" id="PyDetectorAccess.gain_mask"><a class="viewcode-back" href="../index.html#PyDetectorAccess.PyDetectorAccess.gain_mask">[docs]</a>    <span class="k">def</span> <span class="nf">gain_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">gain</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns a gain map extracted from detector configuration data.</span>
<span class="sd">           Currently implemented for CSPAD only.</span>
<span class="sd">           Returns None for other detectors or missing configuration for CSPAD.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">runnum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runnum</span><span class="p">(</span><span class="n">par</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">runnum</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">runnum_cfg</span> <span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg_gain_mask_is_loaded</span> <span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gain_mask</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runnum_cfg</span> <span class="o">=</span> <span class="n">runnum</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cfg_gain_mask_is_loaded</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span>   <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">CSPAD</span>    <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gain_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cspad_gain_mask</span><span class="p">(</span><span class="n">gain</span><span class="p">)</span> 
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">CSPAD2X2</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gain_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cspad2x2_gain_mask</span><span class="p">(</span><span class="n">gain</span><span class="p">)</span> 
        <span class="k">else</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cfg_gain_mask_is_loaded</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gain_mask</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gain_mask</span></div>

<span class="c1">##-----------------------------</span>

<div class="viewcode-block" id="PyDetectorAccess.gain_mask_non_zero"><a class="viewcode-back" href="../index.html#PyDetectorAccess.PyDetectorAccess.gain_mask_non_zero">[docs]</a>    <span class="k">def</span> <span class="nf">gain_mask_non_zero</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">gain</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The same as gain_mask, but returns None if ALL pixels have high gain&quot;&quot;&quot;</span>

        <span class="n">gm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gain_mask</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">gain</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">gm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">gm</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span> 

        <span class="k">return</span> <span class="n">gm</span></div>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">raw_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="p">:</span>

        <span class="c1">#print &#39;TypeId.Type.Id_CspadElement: &#39;, TypeId.Type.Id_CspadElement</span>
        <span class="c1">#print &#39;TypeId.Type.Id_CspadConfig: &#39;,  TypeId.Type.Id_CspadConfig</span>

        <span class="k">if</span>   <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">CSPAD</span>      <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_cspad</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>     <span class="c1"># 3   ms</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">CSPAD2X2</span>   <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_cspad2x2</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>  <span class="c1"># 0.6 ms</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">PRINCETON</span>  <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_princeton</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="c1"># 0.7 ms</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">PNCCD</span>      <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_pnccd</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>     <span class="c1"># 0.8 ms</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">ANDOR</span>      <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_andor</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>     <span class="c1"># 0.1 ms</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">ANDOR3D</span>    <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_andor</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">JUNGFRAU</span>   <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_jungfrau</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">FCCD960</span>    <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_fccd960</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>   <span class="c1"># 11  ms</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">EPIX100A</span>   <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_epix</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>      <span class="c1"># 0.3 ms</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">EPIX10K</span>    <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_epix</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">EPIX</span>       <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_epix</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">ACQIRIS</span>    <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_acqiris</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">OPAL1000</span>   <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_camera</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>    <span class="c1"># 1 ms</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">OPAL2000</span>   <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_camera</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">OPAL4000</span>   <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_camera</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">OPAL8000</span>   <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_camera</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">ORCAFL40</span>   <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_camera</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">TM6740</span>     <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_camera</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>    <span class="c1"># 0.24 ms</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">QUARTZ4A150</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_camera</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">RAYONIX</span>    <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_camera</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">IMP</span>        <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_imp</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">FCCD</span>       <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_camera</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">TIMEPIX</span>    <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_timepix</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">FLI</span>        <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_fli</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">PIMAX</span>      <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_pimax</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">ZYLA</span>       <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_zyla</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">EPICSCAM</span>   <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_camera</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
        <span class="k">else</span>                               <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">raw_data_cspad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="p">:</span>

        <span class="c1"># data object</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_cspad_data_object</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>        
        <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbits</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="p">:</span> <span class="nb">print</span> <span class="s1">&#39;cspad data object is not found&#39;</span>
            <span class="k">return</span> <span class="kc">None</span>
    
        <span class="c1"># configuration from data</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_cspad_config_object</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbits</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="p">:</span> <span class="nb">print</span> <span class="s1">&#39;cspad config object is not found&#39;</span>
            <span class="k">return</span> <span class="kc">None</span>
    
        <span class="n">nquads</span>   <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">quads_shape</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nquads_c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">numQuads</span><span class="p">()</span>

        <span class="c1">#print &#39;d.TypeId: &#39;, d.TypeId</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbits</span> <span class="o">&amp;</span> <span class="mi">8</span> <span class="p">:</span> <span class="nb">print</span> <span class="s1">&#39;nquads in data: </span><span class="si">%d</span><span class="s1"> and config: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nquads</span><span class="p">,</span> <span class="n">nquads_c</span><span class="p">)</span>

        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">185</span><span class="p">,</span><span class="mi">388</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span> <span class="k">if</span> <span class="n">nquads</span><span class="o">&lt;</span><span class="mi">4</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">185</span><span class="p">,</span><span class="mi">388</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">iq</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nquads</span><span class="p">)</span> <span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">quads</span><span class="p">(</span><span class="n">iq</span><span class="p">)</span>
            <span class="n">qnum</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">quad</span><span class="p">()</span>
            <span class="n">qdata</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>
            <span class="n">roim</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">roiMask</span><span class="p">(</span><span class="n">qnum</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbits</span> <span class="o">&amp;</span> <span class="mi">8</span> <span class="p">:</span> <span class="nb">print</span> <span class="s1">&#39;qnum: </span><span class="si">%d</span><span class="s1">  qdata.shape: </span><span class="si">%s</span><span class="s1">, mask: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">qnum</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">qdata</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">roim</span><span class="p">)</span>
    
            <span class="c1">#roim = 0375 # for test only        </span>
            <span class="k">if</span> <span class="n">roim</span> <span class="o">==</span> <span class="mi">0377</span> <span class="p">:</span>
                <span class="n">arr</span><span class="p">[</span><span class="n">qnum</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">qdata</span>

            <span class="k">else</span> <span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbits</span> <span class="p">:</span> <span class="nb">print</span> <span class="s1">&#39;PyDetectorAccessr: quad configuration has non-complete mask = </span><span class="si">%d</span><span class="s1"> of included 2x1&#39;</span> <span class="o">%</span> <span class="n">roim</span>
                <span class="n">qdata_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">8</span><span class="p">,</span><span class="mi">185</span><span class="p">,</span><span class="mi">388</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">qdata</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="p">:</span>
                    <span class="k">if</span> <span class="n">roim</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">s</span><span class="p">)</span> <span class="p">:</span>
                        <span class="n">qdata_full</span><span class="p">[</span><span class="n">s</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">qdata</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
                        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">arr</span><span class="p">[</span><span class="n">qnum</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">qdata_full</span>
    
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbits</span> <span class="o">&amp;</span> <span class="mi">8</span> <span class="p">:</span> <span class="nb">print</span> <span class="s1">&#39;arr.shape: &#39;</span><span class="p">,</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">arr</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="mi">185</span><span class="p">,</span><span class="mi">388</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">arr</span>
    
<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">raw_data_cspad2x2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="p">:</span>
        <span class="c1"># data object</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_cspad2x2_data_object</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># configuration object</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_cspad2x2_config_object</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbits</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter_cspad2x2_msg</span> <span class="o">&lt;</span><span class="mi">3</span> <span class="p">:</span>
                <span class="nb">print</span> <span class="s1">&#39;WARNING PyDetectorAccess: missing configuration object for source </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">str_src</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter_cspad2x2_msg</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">:</span> <span class="nb">print</span> <span class="s1">&#39;Stop WARNING messages for </span><span class="si">%s</span><span class="s1"> configuration&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">str_src</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">counter_cspad2x2_msg</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1">#return None</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">roiMask</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">3</span> <span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbits</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter_cspad2x2_msg</span> <span class="o">&lt;</span><span class="mi">3</span> <span class="p">:</span>
                <span class="nb">print</span> <span class="s1">&#39;WARNING PyDetectorAccess: configuration of </span><span class="si">%s</span><span class="s1"> has non-complete mask=</span><span class="si">%d</span><span class="s1"> of included 2x1&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">str_src</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">roiMask</span><span class="p">())</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter_cspad2x2_msg</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">:</span> <span class="nb">print</span> <span class="s1">&#39;Stop WARNING messages for </span><span class="si">%s</span><span class="s1"> configuration&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">str_src</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">counter_cspad2x2_msg</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">raw_data_camera</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="p">:</span>
        <span class="c1"># data object</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_camera_data_object</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
    
        <span class="c1"># configuration object</span>
        <span class="c1">#c = pda.get_camera_config_object(env, self.source)</span>
        <span class="c1">#if c is None : return None</span>

        <span class="c1">#print &#39;data width: %d, height: %d, depth: %d, offset: %f&#39; % (d.width(), d.height(), d.depth(), d.offset())</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">offset</span><span class="p">()</span>
        
        <span class="n">d16</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">data16</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">d16</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">d16</span> <span class="o">!=</span> <span class="p">[]</span> <span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_offset</span> <span class="p">:</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d16</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> <span class="o">-</span> <span class="n">d</span><span class="o">.</span><span class="n">offset</span><span class="p">()</span>        
            <span class="k">else</span>              <span class="p">:</span> <span class="k">return</span> <span class="n">d16</span>
        
        <span class="n">d8</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">data8</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">d8</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">d8</span> <span class="o">!=</span> <span class="p">[]</span> <span class="p">:</span> 
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_offset</span> <span class="p">:</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d8</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> <span class="o">-</span> <span class="n">d</span><span class="o">.</span><span class="n">offset</span><span class="p">()</span> 
            <span class="k">else</span>              <span class="p">:</span> <span class="k">return</span> <span class="n">d8</span>

        <span class="k">return</span> <span class="kc">None</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">raw_data_fccd960</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="p">:</span>
        <span class="c1"># data object</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_camera_data_object</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
    
        <span class="c1"># configuration object</span>
        <span class="c1">#c = pda.get_camera_config_object(env, self.source)</span>
        <span class="c1">#if c is None : return None</span>

        <span class="n">arr</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">data16</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">arr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>

        <span class="n">arr_c</span> <span class="o">=</span> <span class="p">(</span><span class="n">arr</span><span class="o">&gt;&gt;</span><span class="mi">13</span><span class="p">)</span><span class="o">&amp;</span><span class="mi">03</span>
        <span class="n">arr_v</span> <span class="o">=</span> <span class="n">arr</span><span class="o">&amp;</span><span class="mi">017777</span>
        <span class="c1">#print &#39;arr_c:\n&#39;, arr_c</span>
        <span class="c1">#print &#39;arr_v:\n&#39;, arr_v</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">arr_c</span><span class="o">==</span><span class="mi">0</span><span class="p">,</span> <span class="n">arr_c</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span> <span class="n">arr_c</span><span class="o">==</span><span class="mi">3</span><span class="p">],</span> \
                         <span class="p">[</span><span class="n">arr_v</span><span class="p">,</span>    <span class="n">arr_v</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">,</span> <span class="n">arr_v</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">])</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">raw_data_princeton</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="p">:</span>
        <span class="c1"># data object</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_princeton_data_object</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># configuration object</span>
        <span class="c1">#c = pda.get_princeton_config_object(env, self.source)</span>
        <span class="c1">#if c is None : return None</span>
        <span class="c1">#print &#39;config: width: %d, height: %d&#39; % (c.width(), c.height())</span>

        <span class="n">nda</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">nda</span> <span class="k">if</span> <span class="n">nda</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">raw_data_pnccd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="p">:</span>
        <span class="c1"># data object</span>
        <span class="c1">#print &#39;=== in raw_data_pnccd&#39;</span>
        <span class="c1">#d = evt.get(_psana.PNCCD.FullFrameV1, self.source)</span>
        <span class="c1">#d = evt.get(_psana.PNCCD.FramesV1, self.source)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_pnccd_data_object</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>

        <span class="c1">#c = pda.get_pnccd_config_object(env, self.source)</span>
        <span class="c1">#if c is None : return None</span>
        <span class="c1">#print &#39;config: numLinks: %d, payloadSizePerLink: %d&#39; % (d.numLinks(), c.payloadSizePerLink())</span>

        <span class="n">arr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">nlinks</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">numLinks</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlinks</span><span class="p">)</span> <span class="p">:</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">fdata</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>
            <span class="n">arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fdata</span><span class="p">)</span>
            <span class="c1">#print &#39;   data.shape: %s&#39; % (str(fdata.shape))</span>

        <span class="n">nda</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
        <span class="c1">#print &#39;nda.shape: &#39;, nda.shape</span>
        <span class="k">return</span> <span class="n">nda</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">raw_data_andor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="p">:</span>

        <span class="n">d</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_andor_data_object</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbits</span> <span class="o">&amp;</span> <span class="mi">4</span> <span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;Data object:&#39;</span><span class="p">,</span> <span class="n">d</span>
            <span class="nb">print</span> <span class="s1">&#39;shotIdStart = &#39;</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">shotIdStart</span><span class="p">()</span> 
            <span class="nb">print</span> <span class="s1">&#39;readoutTime = &#39;</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">readoutTime</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s1">&#39;temperature = &#39;</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">temperature</span><span class="p">()</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_andor_config_object</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>                

        <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbits</span> <span class="o">&amp;</span> <span class="mi">4</span> <span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;Configuration object:&#39;</span><span class="p">,</span> <span class="n">c</span>
            <span class="nb">print</span> <span class="s1">&#39;width              = &#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">width</span><span class="p">()</span>            
            <span class="nb">print</span> <span class="s1">&#39;height             = &#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">height</span><span class="p">()</span>            
            <span class="nb">print</span> <span class="s1">&#39;numSensors         = &#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">numSensors</span><span class="p">()</span>        
            <span class="nb">print</span> <span class="s1">&#39;orgX               = &#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">orgX</span><span class="p">()</span>              
            <span class="nb">print</span> <span class="s1">&#39;orgY               = &#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">orgY</span><span class="p">()</span>              
            <span class="nb">print</span> <span class="s1">&#39;binX               = &#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">binX</span><span class="p">()</span>              
            <span class="nb">print</span> <span class="s1">&#39;binY               = &#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">binY</span><span class="p">()</span>              
            <span class="nb">print</span> <span class="s1">&#39;exposureTime       = &#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">exposureTime</span><span class="p">()</span>      
            <span class="nb">print</span> <span class="s1">&#39;coolingTemp        = &#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">coolingTemp</span> <span class="p">()</span>      
            <span class="nb">print</span> <span class="s1">&#39;fanMode            = &#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">fanMode</span> <span class="p">()</span>          
            <span class="nb">print</span> <span class="s1">&#39;baselineClamp      = &#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">baselineClamp</span><span class="p">()</span>     
            <span class="nb">print</span> <span class="s1">&#39;highCapacity       = &#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">highCapacity</span><span class="p">()</span>      
            <span class="nb">print</span> <span class="s1">&#39;gainIndex          = &#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">gainIndex</span><span class="p">()</span>         
            <span class="nb">print</span> <span class="s1">&#39;readoutSpeedIndex  = &#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">readoutSpeedIndex</span><span class="p">()</span> 
            <span class="nb">print</span> <span class="s1">&#39;exposureEventCode  = &#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">exposureEventCode</span><span class="p">()</span> 
            <span class="nb">print</span> <span class="s1">&#39;exposureStartDelay = &#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">exposureStartDelay</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s1">&#39;numDelayShots      = &#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">numDelayShots</span><span class="p">()</span>     
            <span class="nb">print</span> <span class="s1">&#39;frameSize          = &#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">frameSize</span><span class="p">()</span>         
            <span class="nb">print</span> <span class="s1">&#39;numPixelsX         = &#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">numPixelsX</span><span class="p">()</span>        
            <span class="nb">print</span> <span class="s1">&#39;numPixelsY         = &#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">numPixelsY</span><span class="p">()</span>        
            <span class="nb">print</span> <span class="s1">&#39;numPixelsPerSensor = &#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">numPixelsPerSensor</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s1">&#39;numPixels          = &#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">numPixels</span><span class="p">()</span>         

        <span class="n">nda</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">nda</span> <span class="k">if</span> <span class="n">nda</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">raw_data_jungfrau</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_jungfrau_data_object</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">d</span><span class="o">.</span><span class="n">frame</span><span class="p">()</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">raw_data_epix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="p">:</span>
        <span class="c1"># data object</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_epix_data_object</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># configuration object</span>
        <span class="c1">#c = pda.get_epix_config_object(env, self.source)</span>
        <span class="c1">#if c is None : return None</span>

        <span class="c1">#print &#39;config: rows: %d, cols: %d, asics: %d&#39; % (c.numberOfRows(), c.numberOfColumns(), c.numberOfAsics())</span>
        <span class="c1">#print &#39;config: digitalCardId0: %d, 1: %d&#39; % (c.digitalCardId0(), c.digitalCardId1())</span>
        <span class="c1">#print &#39;config: analogCardId0 : %d, 1: %d&#39; % (c.analogCardId0(),  c.analogCardId1())</span>
        <span class="c1">#print &#39;config: version: %d, asicMask: %d&#39; % (c.version(), c.asicMask())</span>

        <span class="n">nda</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">frame</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">nda</span> <span class="k">if</span> <span class="n">nda</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">raw_data_timepix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="p">:</span>
        <span class="c1"># data object</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_timepix_data_object</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># configuration object</span>
        <span class="c1">#c = pda.get_timepix_config_object(env, self.source)</span>
        <span class="c1">#if c is None : return None</span>
        <span class="c1">#print &#39;config: width: %d, height: %d&#39; % (c.width(), c.height())</span>

        <span class="n">nda</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">nda</span> <span class="k">if</span> <span class="n">nda</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">raw_data_fli</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="p">:</span>
        <span class="c1"># data object</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_fli_data_object</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># configuration object</span>
        <span class="c1">#c = pda.get_fli_config_object(env, self.source)</span>
        <span class="c1">#if c is None : return None</span>
        <span class="c1">#print &#39;config: width: %d, height: %d&#39; % (c.width(), c.height())</span>

        <span class="n">nda</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">nda</span> <span class="k">if</span> <span class="n">nda</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">raw_data_pimax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="p">:</span>
        <span class="c1"># data object</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_pimax_data_object</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># configuration object</span>
        <span class="c1">#c = pda.get_pimax_config_object(env, self.source)</span>
        <span class="c1">#if c is None : return None</span>
        <span class="c1">#print &#39;config: width: %d, height: %d&#39; % (c.width(), c.height())</span>

        <span class="n">nda</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">nda</span> <span class="k">if</span> <span class="n">nda</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">raw_data_zyla</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="p">:</span>
        <span class="c1"># data object</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_zyla_data_object</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># configuration object</span>
        <span class="c1">#c = pda.get_zyla_config_object(env, self.source)</span>
        <span class="c1">#if c is None : return None</span>
        <span class="c1">#print &#39;config: width: %d, height: %d&#39; % (c.width(), c.height())</span>

        <span class="n">nda</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">nda</span> <span class="k">if</span> <span class="n">nda</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

<span class="c1">##-----------------------------</span>
<span class="c1">##-----------------------------</span>
<span class="c1">##-----------------------------</span>
<span class="c1">##-----------------------------</span>

<div class="viewcode-block" id="PyDetectorAccess.raw_data_acqiris"><a class="viewcode-back" href="../index.html#PyDetectorAccess.PyDetectorAccess.raw_data_acqiris">[docs]</a>    <span class="k">def</span> <span class="nf">raw_data_acqiris</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;returns two 2-d ndarrays wf,wt with shape=(nbrChannels, nbrSamples) or None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># data object</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_acqiris_data_object</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># configuration object</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_acqiris_config_object</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>

        <span class="c1">#nchan = d.data_shape()[0]</span>
        <span class="n">nbrChannels</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">nbrChannels</span><span class="p">()</span>

        <span class="n">h</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">horiz</span><span class="p">()</span>
        <span class="n">sampInterval</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">sampInterval</span><span class="p">()</span>
        <span class="n">nbrSamples</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">nbrSamples</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbits</span> <span class="o">&amp;</span> <span class="mi">4</span> <span class="p">:</span> <span class="nb">print</span> <span class="s1">&#39;  nbrChannels: </span><span class="si">%d</span><span class="s1">, H-nbrSamples: </span><span class="si">%d</span><span class="s1">, H-sampInterval: </span><span class="si">%g</span><span class="s1">&#39;</span> \
           <span class="o">%</span> <span class="p">(</span><span class="n">nbrChannels</span><span class="p">,</span> <span class="n">nbrSamples</span><span class="p">,</span> <span class="n">sampInterval</span><span class="p">)</span>

        <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">nbrChannels</span><span class="p">,</span> <span class="n">nbrSamples</span><span class="p">)</span>
        <span class="n">wf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="n">wt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">chan</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbrChannels</span><span class="p">)</span> <span class="p">:</span>
            <span class="n">elem</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">chan</span><span class="p">)</span>
            <span class="n">vert</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">vert</span><span class="p">()[</span><span class="n">chan</span><span class="p">]</span>

            <span class="n">slope</span> <span class="o">=</span> <span class="n">vert</span><span class="o">.</span><span class="n">slope</span><span class="p">()</span>
            <span class="n">offset</span><span class="o">=</span> <span class="n">vert</span><span class="o">.</span><span class="n">offset</span><span class="p">()</span>

            <span class="n">nbrSegments</span>     <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">nbrSegments</span><span class="p">()</span>
            <span class="n">nbrSamplesInSeg</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">nbrSamplesInSeg</span><span class="p">()</span>
            <span class="n">indexFirstPoint</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">indexFirstPoint</span><span class="p">()</span>
            <span class="n">tstamps</span>         <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
            <span class="n">wforms</span>          <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">waveforms</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbits</span> <span class="o">&amp;</span> <span class="mi">4</span> <span class="p">:</span>
                <span class="nb">print</span> <span class="s1">&#39;    chan: </span><span class="si">%d</span><span class="s1">,  nbrSegments: </span><span class="si">%d</span><span class="s1">,  nbrSamplesInSeg: </span><span class="si">%d</span><span class="s1">,  indexFirstPoint: </span><span class="si">%d</span><span class="s1">,&#39;</span> \
                  <span class="o">%</span> <span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">nbrSegments</span><span class="p">,</span> <span class="n">nbrSamplesInSeg</span><span class="p">,</span> <span class="n">indexFirstPoint</span><span class="p">),</span> \
                  <span class="s1">&#39;  V-slope: </span><span class="si">%f</span><span class="s1">,  V-offset: </span><span class="si">%f</span><span class="s1">,  H-pos[seg=0]: </span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">slope</span><span class="p">,</span>  <span class="n">offset</span><span class="p">,</span> <span class="n">tstamps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pos</span><span class="p">())</span>

            <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbrSegments</span><span class="p">)</span> <span class="p">:</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="n">wforms</span><span class="p">[</span><span class="n">seg</span><span class="p">]</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">tstamps</span><span class="p">[</span><span class="n">seg</span><span class="p">]</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span>       
                <span class="n">i0_seg</span> <span class="o">=</span> <span class="n">seg</span> <span class="o">*</span> <span class="n">nbrSamplesInSeg</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">pos</span><span class="o">/</span><span class="n">sampInterval</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">correct_time</span> <span class="k">else</span> <span class="n">seg</span> <span class="o">*</span> <span class="n">nbrSamplesInSeg</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">nbrSamplesInSeg</span> <span class="k">if</span> <span class="p">(</span><span class="n">i0_seg</span> <span class="o">+</span> <span class="n">nbrSamplesInSeg</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">nbrSamples</span> <span class="k">else</span> <span class="n">nbrSamples</span> <span class="o">-</span> <span class="n">i0_seg</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">correct_time</span> <span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">indexFirstPoint</span> <span class="o">+</span> <span class="n">size</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">nbrSamplesInSeg</span> <span class="p">:</span> <span class="n">size</span> <span class="o">=</span> <span class="n">nbrSamplesInSeg</span> <span class="o">-</span> <span class="n">indexFirstPoint</span>

                    <span class="n">wf</span><span class="p">[</span><span class="n">chan</span><span class="p">,</span> <span class="n">i0_seg</span><span class="p">:</span><span class="n">i0_seg</span><span class="o">+</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="n">indexFirstPoint</span><span class="p">:</span><span class="n">indexFirstPoint</span><span class="o">+</span><span class="n">size</span><span class="p">]</span><span class="o">*</span><span class="n">slope</span> <span class="o">-</span> <span class="n">offset</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="n">wf</span><span class="p">[</span><span class="n">chan</span><span class="p">,</span> <span class="n">i0_seg</span><span class="p">:</span><span class="n">i0_seg</span><span class="o">+</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">size</span><span class="p">]</span><span class="o">*</span><span class="n">slope</span> <span class="o">-</span> <span class="n">offset</span>

                <span class="n">wt</span><span class="p">[</span><span class="n">chan</span><span class="p">,</span> <span class="n">i0_seg</span><span class="p">:</span><span class="n">i0_seg</span><span class="o">+</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="o">*</span><span class="n">sampInterval</span> <span class="o">+</span> <span class="n">pos</span>

        <span class="k">return</span> <span class="n">wf</span><span class="p">,</span> <span class="n">wt</span></div>

<span class="c1">##-----------------------------</span>

<div class="viewcode-block" id="PyDetectorAccess.raw_data_imp"><a class="viewcode-back" href="../index.html#PyDetectorAccess.PyDetectorAccess.raw_data_imp">[docs]</a>    <span class="k">def</span> <span class="nf">raw_data_imp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;returns ndarray with shape=(4, 1023) or None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># data object</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_imp_data_object</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbits</span> <span class="o">&amp;</span> <span class="mi">4</span> <span class="p">:</span>
            <span class="c1"># configuration object</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_imp_config_object</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>

            <span class="nb">print</span> <span class="s2">&quot;Configuration object for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span>
            <span class="nb">print</span> <span class="s2">&quot;  range =&quot;</span><span class="p">,</span>           <span class="n">c</span><span class="o">.</span><span class="n">range</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s2">&quot;  calRange =&quot;</span><span class="p">,</span>        <span class="n">c</span><span class="o">.</span><span class="n">calRange</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s2">&quot;  reset =&quot;</span><span class="p">,</span>           <span class="n">c</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s2">&quot;  biasData =&quot;</span><span class="p">,</span>        <span class="n">c</span><span class="o">.</span><span class="n">biasData</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s2">&quot;  calData =&quot;</span><span class="p">,</span>         <span class="n">c</span><span class="o">.</span><span class="n">calData</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s2">&quot;  biasDacData =&quot;</span><span class="p">,</span>     <span class="n">c</span><span class="o">.</span><span class="n">biasDacData</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s2">&quot;  calStrobe =&quot;</span><span class="p">,</span>       <span class="n">c</span><span class="o">.</span><span class="n">calStrobe</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s2">&quot;  numberOfSamples =&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">numberOfSamples</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s2">&quot;  trigDelay =&quot;</span><span class="p">,</span>       <span class="n">c</span><span class="o">.</span><span class="n">trigDelay</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s2">&quot;  adcDelay =&quot;</span><span class="p">,</span>        <span class="n">c</span><span class="o">.</span><span class="n">adcDelay</span><span class="p">()</span>
            
            <span class="nb">print</span> <span class="s2">&quot;Data object for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span>
            <span class="nb">print</span> <span class="s2">&quot;  vc =&quot;</span><span class="p">,</span>          <span class="n">d</span><span class="o">.</span><span class="n">vc</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s2">&quot;  lane =&quot;</span><span class="p">,</span>        <span class="n">d</span><span class="o">.</span><span class="n">lane</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s2">&quot;  frameNumber =&quot;</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">frameNumber</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s2">&quot;  range =&quot;</span><span class="p">,</span>       <span class="n">d</span><span class="o">.</span><span class="n">range</span><span class="p">()</span>
            
            <span class="n">laneStatus</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">laneStatus</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s2">&quot;  laneStatus.linkErrCount =&quot;</span><span class="p">,</span>  <span class="n">laneStatus</span><span class="o">.</span><span class="n">linkErrCount</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s2">&quot;  laneStatus.linkDownCount =&quot;</span><span class="p">,</span> <span class="n">laneStatus</span><span class="o">.</span><span class="n">linkDownCount</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s2">&quot;  laneStatus.cellErrCount =&quot;</span><span class="p">,</span>  <span class="n">laneStatus</span><span class="o">.</span><span class="n">cellErrCount</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s2">&quot;  laneStatus.rxCount =&quot;</span><span class="p">,</span>       <span class="n">laneStatus</span><span class="o">.</span><span class="n">rxCount</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s2">&quot;  laneStatus.locLinked =&quot;</span><span class="p">,</span>     <span class="n">laneStatus</span><span class="o">.</span><span class="n">locLinked</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s2">&quot;  laneStatus.remLinked =&quot;</span><span class="p">,</span>     <span class="n">laneStatus</span><span class="o">.</span><span class="n">remLinked</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s2">&quot;  laneStatus.zeros =&quot;</span><span class="p">,</span>         <span class="n">laneStatus</span><span class="o">.</span><span class="n">zeros</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s2">&quot;  laneStatus.powersOkay =&quot;</span><span class="p">,</span>    <span class="n">laneStatus</span><span class="o">.</span><span class="n">powersOkay</span><span class="p">()</span>

        <span class="n">lst_of_samps</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">samples</span><span class="p">()</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">sample</span><span class="o">.</span><span class="n">channels</span><span class="p">()</span> <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">lst_of_samps</span><span class="p">])</span>
        <span class="c1"># Transpose converts (1023, 4) to (4, 1023)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_calib_imp</span> <span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_imp_config_object</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
            <span class="n">bias</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">biasData</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> <span class="o">-</span> <span class="n">bias</span>

        <span class="k">return</span> <span class="n">a</span></div>

<span class="c1">##-----------------------------</span>

<div class="viewcode-block" id="PyDetectorAccess.cspad_gain_mask"><a class="viewcode-back" href="../index.html#PyDetectorAccess.PyDetectorAccess.cspad_gain_mask">[docs]</a>    <span class="k">def</span> <span class="nf">cspad_gain_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gain</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Returns the gain mask of 1/0 for low/high gain pixels as a numpy array of shape=(32,185,388), dtype=uint8.</span>
<span class="sd">            If gain is set, method returns a map of (float) gain/1 values for low/high gain pixels, respectively.</span>
<span class="sd">            None is returned if configuration data is missing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># configuration from data</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_cspad_config_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.cspad_gain_mask - config object is not available&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="c1">#raise IOError(msg)</span>
            <span class="nb">print</span> <span class="n">msg</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1">#self.gm = np.empty((32,185,388), dtype=np.uint8)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">32</span><span class="p">,</span><span class="mi">185</span><span class="p">,</span><span class="mi">388</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">asic1</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">185</span><span class="p">,</span><span class="mi">194</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">iquad</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">quads_shape</span><span class="p">()[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="c1"># need in copy to right shift bits</span>
            <span class="n">gm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">quads</span><span class="p">(</span><span class="n">iquad</span><span class="p">)</span><span class="o">.</span><span class="n">gm</span><span class="p">()</span><span class="o">.</span><span class="n">gainMap</span><span class="p">())</span>
            
            <span class="k">for</span> <span class="n">i2x1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
                <span class="n">gmasic0</span> <span class="o">=</span> <span class="n">gm</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="c1"># take the lowest bit only</span>
                <span class="n">gm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">right_shift</span><span class="p">(</span><span class="n">gm</span><span class="p">,</span> <span class="n">asic1</span><span class="p">)</span>
                <span class="n">gm2x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">gmasic0</span><span class="p">,</span> <span class="n">gm</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gm</span><span class="p">[</span><span class="n">i2x1</span><span class="o">+</span><span class="n">iquad</span><span class="o">*</span><span class="mi">8</span><span class="p">][:][:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">gm2x1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i2x1</span> <span class="o">&lt;</span> <span class="mi">7</span> <span class="p">:</span> <span class="n">gm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">right_shift</span><span class="p">(</span><span class="n">gm</span><span class="p">,</span> <span class="n">asic1</span><span class="p">)</span> <span class="c1"># do not shift for last asic</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cfg_gain_mask_is_loaded</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">gain</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">gm</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">f</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">gain</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gm</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span> <span class="o">*</span> <span class="n">f</span> <span class="o">+</span> <span class="mi">1</span></div>

<span class="c1">##-----------------------------</span>

<div class="viewcode-block" id="PyDetectorAccess.cspad2x2_gain_mask"><a class="viewcode-back" href="../index.html#PyDetectorAccess.PyDetectorAccess.cspad2x2_gain_mask">[docs]</a>    <span class="k">def</span> <span class="nf">cspad2x2_gain_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gain</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Returns the gain mask of 1/0 for low/high gain pixels as a numpy array of shape=(2,185,388), dtype=uint8.</span>
<span class="sd">            If gain is set, method returns a map of (float) gain/1 values for low/high gain pixels, respectively.</span>
<span class="sd">            None is returned if configuration data is missing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># configuration from data</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_cspad2x2_config_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.cspad_gain_mask - config object is not available&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="c1">#raise IOError(msg)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbits</span> <span class="p">:</span> <span class="nb">print</span> <span class="n">msg</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1">#self.gm = np.empty((2,185,388), dtype=np.uint8)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">185</span><span class="p">,</span><span class="mi">388</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">asic1</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">185</span><span class="p">,</span><span class="mi">194</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

        <span class="n">gm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">quad</span><span class="p">()</span><span class="o">.</span><span class="n">gm</span><span class="p">()</span><span class="o">.</span><span class="n">gainMap</span><span class="p">())</span>

        <span class="c1"># see the DAQ pdsapp/config/Cspad2x2GainMap.cc:export_() to see that</span>
        <span class="c1"># the 4 bits in each element of the gainmap array correspond to the</span>
        <span class="c1"># 4 ASICs in the 2x2.  playing around with the DAQ configdb_gui</span>
        <span class="c1"># (export/import the text file) shows that the ASICS are numbered</span>
        <span class="c1"># like this:</span>
        <span class="c1">#   1 3</span>
        <span class="c1">#   0 2</span>
        <span class="c1"># I am assuming the above corresponds to the 2x2 &quot;natural shape&quot;</span>
        <span class="c1"># of [2,185,388] in a natural way.</span>
        <span class="k">for</span> <span class="n">i2x1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">gmasic0</span> <span class="o">=</span> <span class="n">gm</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="c1"># take the lowest bit only</span>
            <span class="n">gm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">right_shift</span><span class="p">(</span><span class="n">gm</span><span class="p">,</span> <span class="n">asic1</span><span class="p">)</span>
            <span class="n">gm2x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">gmasic0</span><span class="p">,</span> <span class="n">gm</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gm</span><span class="p">[</span><span class="n">i2x1</span><span class="p">][:][:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">gm2x1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i2x1</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">gm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">right_shift</span><span class="p">(</span><span class="n">gm</span><span class="p">,</span> <span class="n">asic1</span><span class="p">)</span> <span class="c1"># do not shift for last asic</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cfg_gain_mask_is_loaded</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">gain</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">gm</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">f</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">gain</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gm</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span> <span class="o">*</span> <span class="n">f</span> <span class="o">+</span> <span class="mi">1</span></div>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">raw_data_cspad_v0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="p">:</span>

        <span class="c1"># data object</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_cspad_data_object</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>        
        <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbits</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="p">:</span> <span class="nb">print</span> <span class="s1">&#39;cspad data object is not found&#39;</span>
            <span class="k">return</span> <span class="kc">None</span>
    
        <span class="c1"># configuration from data</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_cspad_config_object</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbits</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="p">:</span> <span class="nb">print</span> <span class="s1">&#39;cspad config object is not found&#39;</span>
            <span class="k">return</span> <span class="kc">None</span>
    
        <span class="n">nquads</span>   <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">quads_shape</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nquads_c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">numQuads</span><span class="p">()</span>

        <span class="c1">#print &#39;d.TypeId: &#39;, d.TypeId</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbits</span> <span class="o">&amp;</span> <span class="mi">8</span> <span class="p">:</span> <span class="nb">print</span> <span class="s1">&#39;nquads in data: </span><span class="si">%d</span><span class="s1"> and config: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nquads</span><span class="p">,</span> <span class="n">nquads_c</span><span class="p">)</span>

        <span class="n">arr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">iq</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nquads</span><span class="p">)</span> <span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">quads</span><span class="p">(</span><span class="n">iq</span><span class="p">)</span>
            <span class="n">qnum</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">quad</span><span class="p">()</span>
            <span class="n">qdata</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>
            <span class="c1">#n2x1stored = qdata.shape[0]</span>
            <span class="n">roim</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">roiMask</span><span class="p">(</span><span class="n">qnum</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbits</span> <span class="o">&amp;</span> <span class="mi">8</span> <span class="p">:</span> <span class="nb">print</span> <span class="s1">&#39;qnum: </span><span class="si">%d</span><span class="s1">  qdata.shape: </span><span class="si">%s</span><span class="s1">, mask: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">qnum</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">qdata</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">roim</span><span class="p">)</span>
            <span class="c1">#     &#39;  n2x1stored: %d&#39; % (n2x1stored)</span>
    
            <span class="c1">#roim = 0375 # for test only</span>
        
            <span class="k">if</span> <span class="n">roim</span> <span class="o">==</span> <span class="mi">0377</span> <span class="p">:</span> <span class="n">arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qdata</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbits</span> <span class="p">:</span> <span class="nb">print</span> <span class="s1">&#39;PyDetectorAccessr: quad configuration has non-complete mask = </span><span class="si">%d</span><span class="s1"> of included 2x1&#39;</span> <span class="o">%</span> <span class="n">roim</span>
                <span class="n">qdata_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">8</span><span class="p">,</span><span class="mi">185</span><span class="p">,</span><span class="mi">388</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">qdata</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="p">:</span>
                    <span class="k">if</span> <span class="n">roim</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">s</span><span class="p">)</span> <span class="p">:</span>
                        <span class="n">qdata_full</span><span class="p">[</span><span class="n">s</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">qdata</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
                        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qdata_full</span><span class="p">)</span>
    
        <span class="n">nda</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbits</span> <span class="o">&amp;</span> <span class="mi">8</span> <span class="p">:</span> <span class="nb">print</span> <span class="s1">&#39;nda.shape: &#39;</span><span class="p">,</span> <span class="n">nda</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">nda</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="mi">185</span><span class="p">,</span><span class="mi">388</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nda</span>

<span class="c1">##-----------------------------</span>
<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">shape_config_cspad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="p">:</span>
        <span class="c1"># configuration from data file</span>
        <span class="c1"># config object for cspad contains a number of used 2x1-s numSect()</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_cspad_config_object</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="c1">#c.numQuads()</span>
        <span class="c1">#return (c.numSect(), 185, 388)</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">185</span><span class="p">,</span> <span class="mi">388</span><span class="p">)</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">shape_config_cspad2x2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_cspad2x2_config_object</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="c1">#c.numAsicsStored(), o.payloadSize()</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">185</span><span class="p">,</span> <span class="mi">388</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># no other choice</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">shape_config_epix100</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_epix_config_object</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">numberOfRows</span><span class="p">(),</span> <span class="n">c</span><span class="o">.</span><span class="n">numberOfColumns</span><span class="p">())</span> 
        <span class="c1">#return (704, 768) # no other choice</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">shape_config_pnccd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_pnccd_config_object</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">numSubmodules</span><span class="p">(),</span> <span class="n">c</span><span class="o">.</span><span class="n">numSubmoduleRows</span><span class="p">(),</span> <span class="n">c</span><span class="o">.</span><span class="n">numSubmoduleChannels</span><span class="p">())</span>
        <span class="c1">#c.numRows(), c.numChannels(), c.numLinks()</span>
        <span class="c1">#return (4, 512, 512) # no other choice</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">shape_config_princeton</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_princeton_config_object</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">numPixelsY</span><span class="p">(),</span> <span class="n">c</span><span class="o">.</span><span class="n">numPixelsX</span><span class="p">())</span>
        <span class="c1">#return (c.height()/c.binY(), c.width()/c.binX())</span>
        <span class="c1">#return (1300, 1340)</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">shape_config_rayonix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="p">:</span>
        <span class="c1"># configuration from data file</span>
        <span class="c1"># config object for rayonix has a number of pixel in the bin for both dimansions</span>
        <span class="c1"># maximal detector size is 3840x3840, pixel size is 44.5um </span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_rayonix_config_object</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="n">npix_in_colbin</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">binning_f</span><span class="p">()</span>
        <span class="n">npix_in_rowbin</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">binning_s</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">npix_in_rowbin</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">npix_in_colbin</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">:</span> <span class="k">return</span> <span class="p">(</span><span class="mi">3840</span><span class="o">/</span><span class="n">npix_in_rowbin</span><span class="p">,</span> <span class="mi">3840</span><span class="o">/</span><span class="n">npix_in_colbin</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">shape_config_andor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="p">:</span>
        <span class="c1"># configuration from data file</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_andor_config_object</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="n">nsegs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span>    <span class="p">:</span> <span class="n">nsegs</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">numSensors</span><span class="p">()</span>
        <span class="k">except</span> <span class="p">:</span> <span class="k">pass</span>
        <span class="c1">#npixx = c.numPixelsY() # for Andor3D only</span>
        <span class="c1">#npixy = c.numPixelsX() # for Andor3D only</span>
        <span class="n">npixx</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">width</span><span class="p">()</span> <span class="o">/</span> <span class="n">c</span><span class="o">.</span><span class="n">binX</span><span class="p">()</span>
        <span class="n">npixy</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">height</span><span class="p">()</span> <span class="o">/</span> <span class="n">c</span><span class="o">.</span><span class="n">binY</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">npixx</span> <span class="ow">and</span> <span class="n">npixy</span> <span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">npixy</span><span class="p">,</span> <span class="n">npixx</span><span class="p">)</span> <span class="k">if</span> <span class="n">nsegs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="n">nsegs</span><span class="p">,</span> <span class="n">npixy</span><span class="p">,</span> <span class="n">npixx</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="c1">##-----------------------------</span>

<div class="viewcode-block" id="PyDetectorAccess.shape_config_jungfrau"><a class="viewcode-back" href="../index.html#PyDetectorAccess.PyDetectorAccess.shape_config_jungfrau">[docs]</a>    <span class="k">def</span> <span class="nf">shape_config_jungfrau</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Shape of jungfrau data array. Returns tuple like (nsegs,512,1024)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_jungfrau_config_object</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="n">nsegs</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">numberOfModules</span><span class="p">()</span>
        <span class="n">nrows</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">numberOfRowsPerModule</span><span class="p">()</span>
        <span class="n">ncols</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">numberOfColumnsPerModule</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">nsegs</span><span class="p">,</span> <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">)</span></div>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">shape_config_timepix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="p">:</span>
        <span class="c1"># configuration from data file</span>
        <span class="c1">#c = pda.get_timepix_config_object(env, self.source)</span>
        <span class="c1"># config object does not have shape parameters,</span>
        <span class="c1"># (o.height(), o.width()) are available in data object  </span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">shape_config_fli</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="p">:</span>
        <span class="c1"># configuration from data file</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_fli_config_object</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">numPixelsY</span><span class="p">(),</span> <span class="n">c</span><span class="o">.</span><span class="n">numPixelsX</span><span class="p">())</span>
        <span class="c1">#return (c.height()/c.binY(), c.width()/c.binX()) # (4096, 4096)</span>


    <span class="k">def</span> <span class="nf">shape_config_pimax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="p">:</span>
        <span class="c1"># configuration from data file</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_pimax_config_object</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">numPixelsY</span><span class="p">(),</span> <span class="n">c</span><span class="o">.</span><span class="n">numPixelsX</span><span class="p">())</span>
        <span class="c1">#return (c.height()/c.binY(), c.width()/c.binX())  # (1024, 1024)</span>


    <span class="k">def</span> <span class="nf">shape_config_zyla</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="p">:</span>
        <span class="c1"># configuration from data file</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_zyla_config_object</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">numPixelsY</span><span class="p">(),</span> <span class="n">c</span><span class="o">.</span><span class="n">numPixelsX</span><span class="p">())</span>
        <span class="c1">#return (c.height()/c.binY(), c.width()/c.binX())  # (1024, 1024)</span>


    <span class="c1">#def shape_config_imp(self, env) :</span>
    <span class="c1">#    #Waveform detector</span>
    <span class="c1">#    # configuration from data file</span>
    <span class="c1">#    #c = pda.get_imp_config_object(env, self.source)</span>
    <span class="c1">#    # config object does not have shape parameters,</span>
    <span class="c1">#    return (4, 1023) # ???</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">shape_config_camera</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="p">:</span>
        <span class="c1"># configuration from data file</span>
        <span class="n">c</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">gu</span><span class="o">.</span><span class="n">OPAL1000</span><span class="p">,</span> <span class="n">gu</span><span class="o">.</span><span class="n">OPAL2000</span><span class="p">,</span> <span class="n">gu</span><span class="o">.</span><span class="n">OPAL4000</span><span class="p">,</span> <span class="n">gu</span><span class="o">.</span><span class="n">OPAL8000</span><span class="p">)</span> <span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_opal1k_config_object</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">FCCD</span> <span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_fccd_config_object</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>     
            <span class="c1">#return (c.height(), c.width())</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">FCCD960</span> <span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_fccd_config_object</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
            <span class="c1">#return (c.height(), c.width())</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">ORCAFL40</span> <span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_orca_config_object</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
            <span class="c1">#return (c.height(), c.width())</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">TM6740</span> <span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_tm6740_config_object</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">QUARTZ4A150</span> <span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_quartz_config_object</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">EPICSCAM</span> <span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_epicscam_config_object</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">height</span><span class="p">(),</span> <span class="n">c</span><span class="o">.</span><span class="n">width</span><span class="p">())</span>

        <span class="c1">#print c</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Row_Pixels</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">Column_Pixels</span><span class="p">)</span>


<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">shape_data_camera</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">)</span> <span class="p">:</span>
        <span class="c1"># camera shape from data object</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">pda</span><span class="o">.</span><span class="n">get_camera_data_object</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">o</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">width</span><span class="p">(),</span><span class="n">o</span><span class="o">.</span><span class="n">height</span><span class="p">())</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">shape_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="p">:</span>

        <span class="c1">#print &#39;TypeId.Type.Id_CspadElement: &#39;, TypeId.Type.Id_CspadElement</span>
        <span class="c1">#print &#39;TypeId.Type.Id_CspadConfig: &#39;,  TypeId.Type.Id_CspadConfig</span>

        <span class="k">if</span>   <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">CSPAD</span>      <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_config_cspad</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">CSPAD2X2</span>   <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_config_cspad2x2</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">EPIX100A</span>   <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_config_epix100</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">PRINCETON</span>  <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_config_princeton</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">PNCCD</span>      <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_config_pnccd</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">ANDOR</span>      <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_config_andor</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">ANDOR3D</span>    <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_config_andor</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">JUNGFRAU</span>   <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_config_jungfrau</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">RAYONIX</span>    <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_config_rayonix</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">gu</span><span class="o">.</span><span class="n">OPAL1000</span><span class="p">,</span> <span class="n">gu</span><span class="o">.</span><span class="n">OPAL2000</span><span class="p">,</span> <span class="n">gu</span><span class="o">.</span><span class="n">OPAL4000</span><span class="p">,</span> <span class="n">gu</span><span class="o">.</span><span class="n">OPAL8000</span><span class="p">,</span>
                              <span class="n">gu</span><span class="o">.</span><span class="n">FCCD</span><span class="p">,</span> <span class="n">gu</span><span class="o">.</span><span class="n">FCCD960</span><span class="p">,</span> <span class="n">gu</span><span class="o">.</span><span class="n">ORCAFL40</span><span class="p">,</span> <span class="n">gu</span><span class="o">.</span><span class="n">TM6740</span><span class="p">,</span> <span class="n">gu</span><span class="o">.</span><span class="n">QUARTZ4A150</span><span class="p">,</span> <span class="n">gu</span><span class="o">.</span><span class="n">EPICSCAM</span><span class="p">)</span> \
                                           <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_config_camera</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>       
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">TIMEPIX</span>    <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_config_timepix</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">FLI</span>        <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_config_fli</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">PIMAX</span>      <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_config_pimax</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="n">gu</span><span class="o">.</span><span class="n">ZYLA</span>       <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_config_zyla</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>

        <span class="c1"># waveform detectors:</span>
        <span class="c1">#elif self.dettype == gu.ACQIRIS    : return self.shape_config_acqiris(env)</span>
        <span class="c1">#elif self.dettype == gu.IMP        : return self.shape_config_imp(env)</span>
        <span class="k">else</span>                               <span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>

<span class="c1">##-----------------------------</span>

<div class="viewcode-block" id="PyDetectorAccess.shape"><a class="viewcode-back" href="../index.html#PyDetectorAccess.PyDetectorAccess.shape">[docs]</a>    <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns the detector shape.</span>

<span class="sd">        Shape is retrieved from configuration object and</span>
<span class="sd">        if it is None, then from calibration file. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">shc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">shc</span> <span class="k">if</span> <span class="n">shc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_calib</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">ctype</span><span class="o">=</span><span class="n">gu</span><span class="o">.</span><span class="n">PEDESTALS</span><span class="p">)</span></div>

<span class="c1">##-----------------------------</span>
<span class="c1"># Static methods</span>
<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">save_txtnda</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="s1">&#39;nda.txt&#39;</span><span class="p">,</span> <span class="n">ndarr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmts</span><span class="o">=</span><span class="p">(),</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.1f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">verbos</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">addmetad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">save_txt</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">ndarr</span><span class="p">,</span> <span class="n">cmts</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">verbos</span><span class="p">,</span> <span class="n">addmetad</span><span class="p">)</span>

<span class="c1">##-----------------------------</span>

    <span class="k">def</span> <span class="nf">load_txtnda</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">nda</span> <span class="o">=</span> <span class="n">load_txt</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nda</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">2</span> <span class="p">:</span> <span class="k">return</span> <span class="n">nda</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span> <span class="n">nda</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span>
        <span class="k">return</span> <span class="n">nda</span></div>

<span class="c1">##-----------------------------</span>

<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">time</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span> <span class="p">:</span>

    <span class="n">ds</span><span class="p">,</span> <span class="n">src</span> <span class="o">=</span> <span class="n">_psana</span><span class="o">.</span><span class="n">DataSource</span><span class="p">(</span><span class="s1">&#39;exp=cxif5315:run=169&#39;</span><span class="p">),</span> <span class="n">_psana</span><span class="o">.</span><span class="n">Source</span><span class="p">(</span><span class="s1">&#39;DetInfo(CxiDs2.0:Cspad.0)&#39;</span><span class="p">)</span>
    <span class="c1">#ds, src = _psana.DataSource(&#39;exp=xcsi0112:run=15&#39;),  _psana.Source(&#39;DetInfo(XcsBeamline.0:Princeton.0)&#39;)</span>

    <span class="n">env</span>  <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">env</span><span class="p">()</span>
    <span class="bp">cls</span>  <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">calibStore</span><span class="p">()</span>
    <span class="n">evts</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">events</span><span class="p">()</span>
    <span class="n">evt</span>  <span class="o">=</span> <span class="n">evts</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">evt</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">:</span> <span class="nb">print</span> <span class="n">key</span>

    <span class="n">det</span> <span class="o">=</span> <span class="n">PyDetectorAccess</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">pbits</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>

    <span class="n">nda</span> <span class="o">=</span> <span class="n">det</span><span class="o">.</span><span class="n">pedestals</span><span class="p">(</span><span class="n">evt</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">pedestals nda:&#39;</span><span class="p">,</span> <span class="n">nda</span>
    <span class="k">if</span> <span class="n">nda</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span> <span class="nb">print</span> <span class="s1">&#39;nda.dtype: </span><span class="si">%s</span><span class="s1"> nda.shape: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nda</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">nda</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="n">t0_sec</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="n">nda</span> <span class="o">=</span> <span class="n">det</span><span class="o">.</span><span class="n">raw_data</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Python consumed time to get raw data (sec) =&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t0_sec</span>

    <span class="nb">print</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">raw_data nda:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">nda</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span> <span class="p">(</span><span class="s1">&#39;Self test is done&#39;</span><span class="p">)</span>

<span class="c1">##-----------------------------</span>
</pre></div>

          </div>
        </div>
      </div>
        </div>
        <div class="sidebar">
          <h3>Table Of Contents</h3>
          
          <div role="search">
            <h3 style="margin-top: 1.5em;">Search</h3>
            <form class="search" action="../search.html" method="get">
                <input type="text" name="q" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
            </form>
          </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

    <div class="footer-wrapper">
      <div class="footer">
        <div class="left">
          <div role="navigation" aria-label="related navigaton">
            <a href="../py-modindex.html" title="Python Module Index"
              >modules</a> |
            <a href="../genindex.html" title="General Index"
              >index</a>
          </div>
          <div role="note" aria-label="source link">
          </div>
        </div>

        <div class="right">
          
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Mikhail Dubrovin.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.3.
    </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

  </body>
</html>